<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Business Card - DuoBuddy</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://res.cloudinary.com data:; script-src 'self' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline'; connect-src 'self' http://localhost:5050 https://duobuddy.my; base-uri 'self'; form-action 'self'; frame-ancestors 'none';">
  
  <style>
    :root {
      --bg1: #0f172a;
      --bg2: #1e293b;
      --primary: #3b82f6;
      --secondary: #10b981;
      --accent: #06b6d4;
      --muted: #64748b;
      --surface: #ffffff;
      --premium1: #f7f9fc;
      --premium2: #eef2ff;
      --premium3: #f1f5f9;
    }
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(99, 102, 241, 0.10), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(16, 185, 129, 0.08), transparent 60%),
        radial-gradient(900px 450px at 50% 110%, rgba(6, 182, 212, 0.08), transparent 65%),
        linear-gradient(180deg, var(--premium1) 0%, var(--premium2) 50%, var(--premium3) 100%);
      background-attachment: fixed;
      color: #0f172a;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
    }
    
    .gradient-bg { background: linear-gradient(135deg, var(--primary) 0%, #2563eb 50%, var(--accent) 100%); }
    .bg-animate { background-size: 200% 200%; animation: gradientShift 8s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(2, 6, 23, 0.12);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    
    .btn {
      padding: 12px 32px;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 16px;
      display: inline-block;
    }
    
    .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, var(--primary) 100%); color: #fff; box-shadow: 0 8px 20px rgba(59,130,246,.35); }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }
    
    .btn-secondary { background: #fff; color: #1e3a8a; border: 2px solid #1e3a8a; }
    
    .btn-secondary:hover {
      background: #1e3a8a;
      color: white;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .input-field {
      width: 100%;
      padding: 14px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .input-field.success {
      border-color: #10b981;
    }
    
    .input-field.error {
      border-color: #ef4444;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 25px;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .page {
      display: none;
      min-height: 100%;
    }
    
    .page.active {
      display: block;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 99999;
      animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .profile-avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 60px;
      font-weight: bold;
      margin: 0 auto 24px;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    .feature-card {
      text-align: center;
      padding: 40px 30px;
      border-radius: 16px;
      background: white;
      transition: all 0.3s;
    }
    
    .feature-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .feature-icon { font-size: 60px; margin-bottom: 20px; display: inline-block; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 6px 12px rgba(2,6,23,.25)); }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .card-slot {
      border: 3px dashed #d1d5db;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      background: #fafafa;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .card-slot.active {
      border-color: #10b981;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-style: solid;
    }
    
    .card-slot:hover:not(.locked) {
      border-color: #3b82f6;
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(59, 130, 246, 0.2);
      background: white;
    }
    
    .status-badge {
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-trial {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    
    .status-active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .status-expired {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th,
    .table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .table th {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      font-weight: 700;
      color: #374151;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
    }
    
    .table tbody tr:hover {
      background: #f9fafb;
    }
    
    .url-suggestion {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      padding: 10px 16px;
      border-radius: 20px;
      margin: 6px;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #1e3a8a;
    }
    
    .url-suggestion:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-content {
      background: white;
      border-radius: 24px;
      max-width: 800px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .validation-message {
      font-size: 14px;
      margin-top: 8px;
      font-weight: 600;
    }
    
    .validation-message.error {
      color: #ef4444;
    }
    
    .validation-message.success {
      color: #10b981;
    }
    
    .validation-message.warning {
      color: #f59e0b;
    }
    
    .hero-section {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
      padding: 100px 20px;
      text-align: center;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: backgroundScroll 20s linear infinite;
    }
    
    @keyframes backgroundScroll {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }
    
    .hero-content {
      position: relative;
      z-index: 1;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    .trial-banner {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }
    
    .expired-banner {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    }
    
    .filter-btn {
      padding: 10px 20px;
      border-radius: 25px;
      background: #f3f4f6;
      color: #374151;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
    }
    
    .filter-btn:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
    }
    
    .filter-btn.active {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border-color: #1e3a8a;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .social-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 24px 0;
    }
    
    .social-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .social-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .contact-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    
    .contact-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .contact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .site-footer { background: linear-gradient(135deg, #f9fafb 0%, #eef2ff 100%); border-top: 1px solid #e5e7eb; padding: 24px; }
    .footer-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .footer-logo { display: inline-flex; align-items: center; gap: 12px; font-weight: 700; color: #1f2937; }
    .footer-logo-badge { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: 800; }
    .footer-links { display: inline-flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .footer-links a { color: #1e3a8a; text-decoration: none; font-weight: 600; }
    .footer-links a:hover { text-decoration: underline; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Homepage -->
  <div id="homepage" class="page active">
  <nav class="gradient-bg bg-animate p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <div class="flex gap-4"><a href="/login" class="nav-link" data-route="/login">Login</a> <a href="/signup" class="nav-link" data-route="/signup">Sign Up</a>
     </div>
    </div>
   </nav>
   <section class="hero-section bg-animate">
    <div class="hero-content max-w-5xl mx-auto">
     <h2 class="text-6xl font-bold mb-6 animate-pulse">Your Smart Digital Business Card</h2>
     <p class="text-2xl mb-10 opacity-90">Transform networking with NFC-enabled smart cards and personalized profile pages.</p>
     <div class="flex gap-6 justify-center flex-wrap"><a href="/signup" class="btn btn-primary text-lg px-12 py-4" data-route="/signup">üöÄ Get Started Free</a> <a href="/login" class="btn btn-secondary text-lg px-12 py-4" data-route="/login">üîê Login</a>
     </div>
    </div>
   </section><!-- Card Design Slideshow -->
   <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">
     <h3 class="text-4xl font-bold text-center mb-4 text-gray-800">üé® Premium Card Designs</h3>
     <p class="text-center text-gray-600 text-lg mb-12">Choose from our collection of professional NFC business cards</p>
     <div style="position: relative; max-width: 600px; margin: 0 auto;">
      <div id="cardSlideshow" style="position: relative; overflow: hidden; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 375px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
       üé¥ Premium NFC Business Cards
      </div><button onclick="changeSlide(-1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;" onmouseover="this.style.background='white'" onmouseout="this.style.background='rgba(255,255,255,0.9)'">‚ùÆ</button> <button onclick="changeSlide(1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;" onmouseover="this.style.background='white'" onmouseout="this.style.background='rgba(255,255,255,0.9)'">‚ùØ</button>
      <div style="text-align: center; margin-top: 20px;">
       <div id="slideshowDots" style="display: inline-flex; gap: 12px;"><span onclick="currentSlide(0)" style="width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; display: inline-block; cursor: pointer;"></span> <span onclick="currentSlide(1)" style="width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; display: inline-block; cursor: pointer;"></span> <span onclick="currentSlide(2)" style="width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; display: inline-block; cursor: pointer;"></span> <span onclick="currentSlide(3)" style="width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; display: inline-block; cursor: pointer;"></span> <span onclick="currentSlide(4)" style="width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; display: inline-block; cursor: pointer;"></span>
       </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
       <h4 id="slideTitle" style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 8px;">Classic Black</h4>
       <p id="slideDescription" style="color: #6b7280; font-size: 16px;">Professional matte finish with elegant black design</p>
      </div>
     </div>
    </div>
   </section>
   <section class="py-20 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
     <h3 class="text-4xl font-bold text-center mb-16 text-gray-800">Why Choose Premium Business Card?</h3>
     <div class="grid md:grid-cols-4 gap-8">
      <div class="feature-card reveal">
       <div class="feature-icon">
        üé¥
       </div>
       <h4 class="text-2xl font-bold mb-4 text-gray-800">NFC Technology</h4>
       <p class="text-gray-600 text-lg">Tap and share your contact instantly with cutting-edge NFC cards</p>
      </div>
      <div class="feature-card reveal">
       <div class="feature-icon">
        üåê
       </div>
       <h4 class="text-2xl font-bold mb-4 text-gray-800">Personal Profile Page</h4>
       <p class="text-gray-600 text-lg">Get your unique URL with a beautiful digital profile</p>
      </div>
      <div class="feature-card reveal">
      <div class="feature-icon">
        &#9889;&#65039;
      </div>
       <h4 class="text-2xl font-bold mb-4 text-gray-800">Instant Updates</h4>
       <p class="text-gray-600 text-lg">Update your info anytime - no reprinting needed</p>
      </div>
      <div class="feature-card reveal">
       <div class="feature-icon">
        üîí
       </div>
       <h4 class="text-2xl font-bold mb-4 text-gray-800">Secured Access</h4>
       <p class="text-gray-600 text-lg">Each card is protected with a personalized password. Even if stolen, nobody can use your card without your credentials.</p>
      </div>
     </div>
    </div>
   </section>
   <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">
     <h3 class="text-4xl font-bold text-center mb-10 text-gray-800">How To Use</h3>
     <div class="grid md:grid-cols-4 gap-8">
      <div class="card p-8 text-center">
       <div class="text-4xl font-bold text-indigo-600 mb-3">1</div>
       <h4 class="text-xl font-bold text-gray-800 mb-2">Place Order</h4>
       <p class="text-gray-600">Choose your card design and submit your order.</p>
      </div>
      <div class="card p-8 text-center">
       <div class="text-4xl font-bold text-indigo-600 mb-3">2</div>
       <h4 class="text-xl font-bold text-gray-800 mb-2">Edit Profile</h4>
       <p class="text-gray-600">Complete your profile details and set your password.</p>
      </div>
      <div class="card p-8 text-center">
       <div class="text-4xl font-bold text-indigo-600 mb-3">3</div>
       <h4 class="text-xl font-bold text-gray-800 mb-2">Card Delivered</h4>
       <p class="text-gray-600">Your NFC card is produced and shipped to you.</p>
      </div>
      <div class="card p-8 text-center">
       <div class="text-4xl font-bold text-indigo-600 mb-3">4</div>
       <h4 class="text-xl font-bold text-gray-800 mb-2">Tap Your Phone</h4>
       <p class="text-gray-600">Tap the card on your phone to share your profile.</p>
      </div>
     </div>
     <div class="mt-6 text-center text-gray-600">
      <p><strong>Note:</strong> Depends on your phone ‚Äî only phones that support NFC can read the card.</p>
     </div>
    </div>
   </section><!-- Company Bulk Order Section -->
   <section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">
     <div class="text-center mb-16">
      <div class="text-6xl mb-6">
       üè¢
      </div>
      <h3 class="text-5xl font-bold mb-4 text-gray-800">Company Bulk Orders</h3>
      <p class="text-xl text-gray-600">Equip your entire team with professional NFC business cards</p>
     </div>
     <div class="grid lg:grid-cols-2 gap-12 items-center mb-16 reveal">
      <div class="card p-10">
       <div class="text-center mb-8"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy Enterprise Logo" style="display: block; max-width: 220px; margin: 0 auto 20px;">
        <h4 class="text-3xl font-bold text-gray-800 mb-2">DuoBuddy Enterprise</h4>
        <p class="text-gray-600 mb-1">Registration: 202403241422 (TR0308714-M)</p>
       </div>
       <div class="space-y-6">
        <div class="flex gap-4">
         <div class="text-3xl">
          üíº
         </div>
         <div>
          <h5 class="font-bold text-xl text-gray-800 mb-2">Unified Design</h5>
          <p class="text-gray-600">All staff cards feature one consistent design maintaining your brand identity across the organization</p>
         </div>
        </div>
        <div class="flex gap-4">
         <div class="text-3xl">
          üìä
         </div>
         <div>
          <h5 class="font-bold text-xl text-gray-800 mb-2">Bulk Pricing</h5>
          <p class="text-gray-600">Special discounted rates for orders of 10+ cards. Perfect for teams, departments, or entire companies</p>
         </div>
        </div>
        <div class="flex gap-4">
         <div class="text-3xl">
          ‚öôÔ∏è
         </div>
         <div>
          <h5 class="font-bold text-xl text-gray-800 mb-2">Centralized Management</h5>
          <p class="text-gray-600">Admin dashboard to manage all employee cards, update information, and track card distribution</p>
         </div>
        </div>
        <div class="flex gap-4">
         <div class="text-3xl">
          üé®
         </div>
         <div>
          <h5 class="font-bold text-xl text-gray-800 mb-2">Custom Branding</h5>
          <p class="text-gray-600">Add your company logo, colors, and branding elements to create professional cards that represent your business</p>
         </div>
        </div>
        <div class="flex gap-4">
         <div class="text-3xl">
          üöÄ
         </div>
         <div>
          <h5 class="font-bold text-xl text-gray-800 mb-2">Fast Deployment</h5>
          <p class="text-gray-600">Quick turnaround time for bulk orders with coordinated delivery to your office location</p>
         </div>
        </div>
       </div>
      </div>
      <div>
      <div class="card p-10 mb-8 reveal">
        <h4 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bulk Order Packages</h4>
        <div class="space-y-6">
         <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-2xl border-2 border-purple-200">
          <div class="flex justify-between items-center mb-3">
           <h5 class="font-bold text-xl text-gray-800">Small Team</h5><span class="status-badge status-trial">10-25 Cards</span>
          </div>
          <p class="text-3xl font-bold text-purple-600 mb-2">RM 90 <span class="text-lg text-gray-600">per card</span></p>
          <p class="text-gray-600">Perfect for startups and small businesses</p>
         </div>
         <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl border-2 border-green-300">
          <div class="flex justify-between items-center mb-3">
           <h5 class="font-bold text-xl text-gray-800">Medium Business</h5><span class="status-badge status-active">26-50 Cards</span>
          </div>
          <p class="text-3xl font-bold text-green-600 mb-2">RM 80 <span class="text-lg text-gray-600">per card</span></p>
          <p class="text-gray-600">Ideal for growing companies</p>
         </div>
         <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-2xl border-2 border-yellow-300">
          <div class="flex justify-between items-center mb-3">
           <h5 class="font-bold text-xl text-gray-800">Enterprise</h5><span class="status-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">51+ Cards</span>
          </div>
          <p class="text-3xl font-bold text-orange-600 mb-2">RM 70 <span class="text-lg text-gray-600">per card</span></p>
          <p class="text-gray-600">Best value for large organizations</p>
         </div>
        </div>
       </div>
       <div class="card p-8 bg-gradient-to-br from-purple-600 to-blue-600 text-white text-center">
        <h5 class="text-2xl font-bold mb-4">Ready to Equip Your Team?</h5>
        <p class="mb-6 text-lg opacity-90">Contact us for a custom quote and demo</p><button class="btn btn-secondary text-lg px-8 py-4" onclick="showBulkOrderModal()">üìû Request Bulk Order Quote</button>
       </div>
      </div>
     </div>
     <div class="card p-10 bg-gradient-to-r from-purple-50 to-blue-50">
      <h4 class="text-3xl font-bold text-center text-gray-800 mb-8">What's Included in Bulk Orders?</h4>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
       <div class="text-center">
        <div class="text-5xl mb-4">
         ‚úÖ
        </div>
        <h5 class="font-bold text-lg text-gray-800 mb-2">One Design Template</h5>
        <p class="text-gray-600">Consistent branding across all staff cards</p>
       </div>
       <div class="text-center">
        <div class="text-5xl mb-4">
         üë•
        </div>
        <h5 class="font-bold text-lg text-gray-800 mb-2">Individual Profiles</h5>
        <p class="text-gray-600">Each employee gets their own unique URL</p>
       </div>
       <div class="text-center">
        <div class="text-5xl mb-4">
         üéØ
        </div>
        <h5 class="font-bold text-lg text-gray-800 mb-2">Admin Dashboard</h5>
        <p class="text-gray-600">Manage all cards from one central location</p>
       </div>
       <div class="text-center">
        <div class="text-5xl mb-4">
         üõ†Ô∏è
        </div>
        <h5 class="font-bold text-lg text-gray-800 mb-2">Free Setup Support</h5>
        <p class="text-gray-600">We help configure all your team's cards</p>
       </div>
      </div>
     </div>
    </div>
   </section>
  </div><!-- Login Page -->
  <div id="login" class="page">
   <div class="min-h-full bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center p-4">
    <div class="card p-10 max-w-md w-full">
     <div class="text-center mb-8">
      <div class="text-6xl mb-4">
       üîê
      </div>
      <h2 class="text-4xl font-bold text-gray-800">Welcome Back!</h2>
      <p class="text-gray-600 mt-2">Login to access your digital cards</p>
     </div>
     <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="mb-6"><label for="loginEmail" class="block text-gray-700 mb-2 font-semibold">Email Address</label> <input type="email" id="loginEmail" class="input-field" placeholder="your@email.com" required>
      </div>
      <div class="mb-8"><label for="loginPassword" class="block text-gray-700 mb-2 font-semibold">Password</label> <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password" required>
      </div><button type="submit" class="btn btn-primary w-full mb-6" id="loginBtn"> <span id="loginBtnText">üöÄ Login to Dashboard</span> <span id="loginBtnLoading" style="display: none;"><span class="loading"></span></span> </button>
      <div class="text-center">
      <p class="text-gray-600">New here? <a href="/signup" class="text-purple-600 hover:underline font-bold" data-route="/signup">Create Free Account</a></p>
      </div>
     </form>
    <div class="mt-8 text-center"><a href="/" class="btn btn-secondary" data-route="/">‚Üê Back to Home</a>
     </div>
    </div>
   </div>
  </div><!-- Sign Up Page -->
  <div id="signup" class="page">
   <div class="min-h-full bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center p-4">
    <div class="card p-10 max-w-lg w-full">
     <div class="text-center mb-8">
      <div class="text-6xl mb-4">
       ‚ú®
      </div>
      <h2 class="text-4xl font-bold text-gray-800">Join SmartCard</h2>
      <p class="text-gray-600 mt-2">Start your 1-day free trial today!</p>
     </div>
     <form id="signupForm" onsubmit="handleSignup(event)">
      <div class="grid md:grid-cols-2 gap-4 mb-4">
       <div><label for="signupName" class="block text-gray-700 mb-2 font-semibold">Full Name</label> <input type="text" id="signupName" class="input-field" placeholder="John Doe" required>
       </div>
       <div><label for="signupPhone" class="block text-gray-700 mb-2 font-semibold">Phone Number</label> <input type="tel" id="signupPhone" class="input-field" placeholder="+60 12-345 6789" required>
       </div>
      </div>
      <div class="mb-4"><label for="signupEmail" class="block text-gray-700 mb-2 font-semibold">Email Address</label> <input type="email" id="signupEmail" class="input-field" placeholder="your@email.com" required>
      </div>
      <div class="mb-4"><label for="signupUsername" class="block text-gray-700 mb-2 font-semibold">Username (Your URL)</label> <input type="text" id="signupUsername" class="input-field" placeholder="johndoe" required oninput="validateUsername(this.value, 'signup')">
       <p class="text-sm font-semibold mt-2" style="color: #1e3a8a;">üåê Your URL: <span id="signupUrlPreview">duobuddy.my/johndoe</span></p>
       <div id="signupUsernameValidation"></div>
       <div id="signupUsernameSuggestions"></div>
      </div>
      <div class="mb-6"><label for="signupPassword" class="block text-gray-700 mb-2 font-semibold">Password</label> <input type="password" id="signupPassword" class="input-field" placeholder="Create a strong password" required>
      </div><button type="submit" class="btn btn-primary w-full mb-6" id="signupBtn"> <span id="signupBtnText">üéâ Create Free Account</span> <span id="signupBtnLoading" style="display: none;"><span class="loading"></span></span> </button>
      <div class="text-center">
      <p class="text-gray-600">Already a member? <a href="/login" class="hover:underline font-bold" style="color: #1e3a8a;" data-route="/login">Login Here</a></p>
      </div>
     </form>
    <div class="mt-8 text-center"><a href="/" class="btn btn-secondary" data-route="/">‚Üê Back to Home</a>
     </div>
    </div>
   </div>
  </div><!-- My Cards Dashboard -->
  <div id="my-cards" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <div class="flex gap-4"><a href="/profile" class="btn btn-secondary" data-route="/profile">üë§ Profile</a> <button class="btn btn-danger" onclick="handleSignOut()">Sign Out</button>
     </div>
    </div>
   </nav>
   <div class="max-w-7xl mx-auto px-4 py-10">
    <div id="accountStatusBanner"></div>
    <div class="card p-10">
     <div class="text-center mb-10">
      <h2 class="text-4xl font-bold text-gray-800 mb-3">Your Card Collection</h2>
      <p class="text-gray-600 text-lg">Order up to 10 premium NFC business cards ‚Ä¢ RM 99 per card</p>
     </div>
     <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="cardSlotsContainer"><!-- Card slots dynamically generated -->
     </div>
    </div>
   </div>
  </div><!-- User Profile -->
  <div id="profile" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><span class="footer-logo-badge">DB</span> DuoBuddy</a>
     <div class="flex gap-4"><a href="/my-cards" class="btn btn-secondary" data-route="/my-cards">üé¥ My Cards</a> <button class="btn btn-danger" onclick="handleSignOut()">Sign Out</button>
     </div>
    </div>
   </nav>
   <div class="max-w-5xl mx-auto px-4 py-10">
    <div class="card p-10">
     <div class="text-center mb-10">
      <div class="profile-avatar" id="profileAvatar">
       JD
      </div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2" id="profileName">John Doe</h2>
      <p class="text-xl text-gray-600 mb-4" id="profileTitle">Marketing Manager</p>
      <div class="inline-block p-4 bg-gradient-to-r from-purple-100 to-blue-100 rounded-2xl">
       <p class="text-sm text-gray-600 mb-1">Your Dedicated URL:</p>
       <p class="text-2xl font-bold text-purple-600" id="profileURL">duobuddy.my/johndoe</p>
      </div>
     </div>
     <div class="grid md:grid-cols-2 gap-8 mb-10">
      <div class="bg-gray-50 p-6 rounded-2xl">
       <h3 class="font-bold text-xl text-gray-800 mb-4">üìû Contact Information</h3>
       <div class="space-y-3">
        <p class="text-gray-700"><span class="font-semibold">Email:</span> <span id="profileEmail">john@example.com</span></p>
        <div>
         <p class="text-gray-700 mb-2"><span class="font-semibold">Phone:</span> <span id="profilePhone">+60 12-345 6789</span></p>
         <div class="contact-actions" id="profileContactActions"><!-- Contact buttons will be added here -->
         </div>
        </div>
        <p class="text-gray-700"><span class="font-semibold">Company:</span> <span id="profileCompany">Tech Corp</span></p>
       </div>
      </div>
      <div class="bg-gray-50 p-6 rounded-2xl">
       <h3 class="font-bold text-xl text-gray-800 mb-4">‚ÑπÔ∏è About Me</h3>
       <p class="text-gray-700" id="profileAbout">Tell people about yourself...</p>
      </div>
     </div>
     <div id="profileSocialLinks" class="mb-10"><!-- Social links will be added here -->
     </div>
     <div class="flex gap-6 justify-center flex-wrap"><a href="/edit-profile" class="btn btn-primary text-lg" data-route="/edit-profile">‚úèÔ∏è Edit Profile</a> <button class="btn btn-primary text-lg" onclick="openProfilePreview()">üîç Preview Profile</button> <a href="/change-password" class="btn btn-secondary text-lg" data-route="/change-password">&#128273; Change Password</a>
     </div>
    </div>
   </div>
  </div><!-- Edit Profile -->
  <div id="edit-profile" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a><button class="btn btn-danger" onclick="handleSignOut()">Sign Out</button>
    </div>
   </nav>
   <div class="max-w-4xl mx-auto px-4 py-10">
    <div class="card p-10">
     <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Update Your Information</h2><!-- Profile Picture Upload -->
     <div class="text-center mb-8">
      <div class="profile-avatar mb-4" id="editProfileAvatar">
       JD
      </div><img id="editProfileImage" style="display: none; width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 24px; object-fit: cover; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);" alt="Profile Picture">
      <div><label for="profilePictureUpload" class="btn btn-primary cursor-pointer">üì∑ Upload Profile Picture</label> <input type="file" id="profilePictureUpload" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)"> <button type="button" class="btn btn-secondary ml-4" onclick="removeProfilePicture()" id="removeProfilePicBtn" style="display: none;">üóëÔ∏è Remove</button>
      </div>
      <p class="text-sm text-gray-500 mt-2">JPG, PNG or GIF (Max 10MB)</p>
     </div>
     <form id="editProfileForm" onsubmit="handleUpdateProfile(event)">
      <div class="grid md:grid-cols-2 gap-6 mb-6">
       <div><label for="editName" class="block text-gray-700 mb-2 font-semibold">Full Name</label> <input type="text" id="editName" class="input-field" required>
       </div>
       <div><label for="editUsername" class="block text-gray-700 mb-2 font-semibold">Username</label> <input type="text" id="editUsername" class="input-field" required oninput="validateUsername(this.value, 'edit')">
        <p class="text-sm text-purple-600 font-semibold mt-2">URL: <span id="editUrlPreview">duobuddy.my/username</span></p>
        <div id="editUsernameValidation"></div>
        <div id="editUsernameSuggestions"></div>
       </div>
      </div>
      <div class="grid md:grid-cols-2 gap-6 mb-6">
       <div><label for="editJobTitle" class="block text-gray-700 mb-2 font-semibold">Job Title</label> <input type="text" id="editJobTitle" class="input-field">
       </div>
       <div><label for="editCompany" class="block text-gray-700 mb-2 font-semibold">Company</label> <input type="text" id="editCompany" class="input-field">
       </div>
      </div>
      <div class="grid md:grid-cols-2 gap-6 mb-6">
       <div><label class="block text-gray-700 mb-2 font-semibold">Registered Login Email</label><input type="email" id="editLoginEmail" class="input-field" disabled></div>
       <div><label class="block text-gray-700 mb-2 font-semibold">Preferred Email (for preview)</label><input type="email" id="editPreferredEmail" class="input-field" placeholder="preferred@email.com"></div>
      </div>
      <div class="mb-6"><label class="inline-flex items-center gap-2 text-gray-700 font-semibold"><input type="checkbox" id="editUseLoginForPreview"> Use login email for preview</label></div>
      <div class="mb-6"><label for="editPhone" class="block text-gray-700 mb-2 font-semibold">Phone Number</label> <input type="tel" id="editPhone" class="input-field" placeholder="+60 12-345 6789">
      </div>
      <div class="mb-6"><label for="editWhatsapp" class="block text-gray-700 mb-2 font-semibold">WhatsApp Number (Optional)</label> <input type="tel" id="editWhatsapp" class="input-field" placeholder="+60 12-345 6789">
       <p class="text-sm text-gray-500 mt-2">Leave blank to use phone number for WhatsApp</p>
      </div>
      <div class="mb-6"><label class="block text-gray-700 mb-3 font-semibold">üåê Social Media Links (Optional)</label>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label for="editFacebook" class="block text-gray-600 mb-1 text-sm">Facebook Username</label> <input type="text" id="editFacebook" class="input-field" placeholder="yourprofile">
         <p class="text-xs text-gray-500 mt-1">facebook.com/<strong>yourprofile</strong></p>
        </div>
        <div><label for="editInstagram" class="block text-gray-600 mb-1 text-sm">Instagram Username</label> <input type="text" id="editInstagram" class="input-field" placeholder="yourprofile">
         <p class="text-xs text-gray-500 mt-1">instagram.com/<strong>yourprofile</strong></p>
        </div>
        <div><label for="editLinkedin" class="block text-gray-600 mb-1 text-sm">LinkedIn Username</label> <input type="text" id="editLinkedin" class="input-field" placeholder="yourprofile">
         <p class="text-xs text-gray-500 mt-1">linkedin.com/in/<strong>yourprofile</strong></p>
        </div>
        <div><label for="editTwitter" class="block text-gray-600 mb-1 text-sm">Twitter / X Username</label> <input type="text" id="editTwitter" class="input-field" placeholder="yourprofile">
         <p class="text-xs text-gray-500 mt-1">twitter.com/<strong>yourprofile</strong></p>
        </div>
        <div><label for="editTiktok" class="block text-gray-600 mb-1 text-sm">TikTok Username</label> <input type="text" id="editTiktok" class="input-field" placeholder="yourprofile">
         <p class="text-xs text-gray-500 mt-1">tiktok.com/@<strong>yourprofile</strong></p>
        </div>
        <div><label for="editYoutube" class="block text-gray-600 mb-1 text-sm">YouTube Channel</label> <input type="text" id="editYoutube" class="input-field" placeholder="yourchannel">
         <p class="text-xs text-gray-500 mt-1">youtube.com/@<strong>yourchannel</strong></p>
        </div>
        <div><label for="editWebsite" class="block text-gray-600 mb-1 text-sm">Website URL</label> <input type="text" id="editWebsite" class="input-field" placeholder="yourwebsite.com">
         <p class="text-xs text-gray-500 mt-1">Full URL with https://</p>
        </div>
        <div><label for="editOther" class="block text-gray-600 mb-1 text-sm">Other Link URL</label> <input type="text" id="editOther" class="input-field" placeholder="Full URL">
         <p class="text-xs text-gray-500 mt-1">Full URL with https://</p>
        </div>
       </div>
      </div>
      <div class="mb-8"><label for="editAbout" class="block text-gray-700 mb-2 font-semibold">About Me</label> <textarea id="editAbout" class="input-field" rows="4"></textarea>
      </div>
      <div class="flex gap-6 justify-center"><button type="submit" class="btn btn-primary text-lg" id="updateBtn"> <span id="updateBtnText">üíæ Save Changes</span> <span id="updateBtnLoading" style="display: none;"><span class="loading"></span></span> </button> <a href="/profile" class="btn btn-secondary text-lg" data-route="/profile">Cancel</a>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Profile Preview Modal -->
  <div id="profilePreviewModal" style="display: none;">
   <div class="modal-overlay" onclick="closeProfilePreview()">
    <div class="modal-content" onclick="event.stopPropagation()">
     <div class="p-10">
      <div class="flex justify-between items-center mb-8">
       <h3 class="text-4xl font-bold text-gray-800">üîç Profile Preview</h3><button class="text-4xl text-gray-500 hover:text-gray-800" onclick="closeProfilePreview()">√ó</button>
      </div>
      <div class="text-center mb-10">
       <div class="profile-avatar mb-4" id="previewProfileAvatar">
        JD
       </div><img id="previewProfileImage" style="display: none; width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 24px; object-fit: cover; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);" alt="Profile Picture">
       <h2 class="text-4xl font-bold text-gray-800 mb-2" id="previewProfileName">Your Name</h2>
       <p class="text-2xl text-gray-600 mb-4" id="previewProfileTitle">Your Job Title</p>
       <div class="inline-block p-4 bg-gradient-to-r from-purple-100 to-blue-100 rounded-2xl">
        <p class="text-sm text-gray-600 mb-1">Your Public URL:</p>
        <p class="text-2xl font-bold text-purple-600" id="previewProfileURL">duobuddy.my/username</p>
       </div>
      </div>
      <div class="grid md:grid-cols-2 gap-8 mb-10">
       <div class="bg-gray-50 p-6 rounded-2xl">
        <h3 class="font-bold text-xl text-gray-800 mb-4">üìû Contact Information</h3>
        <div class="space-y-3">
         <p class="text-gray-700"><span class="font-semibold">Email:</span> <span id="previewProfileEmail">your@email.com</span></p>
         <div>
          <p class="text-gray-700 mb-2"><span class="font-semibold">Phone:</span> <span id="previewProfilePhone">+60 12-345 6789</span></p>
          <div class="contact-actions" id="previewProfileContactActions"><!-- Contact buttons will be added here -->
          </div>
         </div>
         <p class="text-gray-700"><span class="font-semibold">Company:</span> <span id="previewProfileCompany">Your Company</span></p>
        </div>
       </div>
       <div class="bg-gray-50 p-6 rounded-2xl">
        <h3 class="font-bold text-xl text-gray-800 mb-4">‚ÑπÔ∏è About Me</h3>
        <p class="text-gray-700" id="previewProfileAbout">Tell people about yourself...</p>
       </div>
      </div>
      <div id="previewProfileSocialLinks" class="mb-10"><!-- Social links will be added here -->
      </div>
      <div class="flex gap-4 justify-center"><button class="btn btn-primary text-lg" onclick="openPublicProfileInNewTab()">üåê Open Full Profile</button> <button class="btn btn-secondary text-lg" onclick="closeProfilePreview()">Close Preview</button>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Public Profile View Page -->
  <div id="public-profile" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <div class="flex gap-4"><a href="/" class="nav-link" data-route="/">Home</a>
     </div>
    </div>
   </nav>
   <div class="min-h-full bg-gradient-to-br from-purple-50 to-blue-50 py-10">
    <div class="max-w-4xl mx-auto px-4">
     <div class="card p-10">
      <div class="text-center mb-10">
       <div class="profile-avatar mb-4" id="publicProfileAvatar">
        ?
       </div><img id="publicProfileImage" style="display: none; width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 24px; object-fit: cover; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);" alt="Profile Picture">
       <h2 class="text-4xl font-bold text-gray-800 mb-2" id="publicProfileName">Loading...</h2>
       <p class="text-2xl text-gray-600 mb-4" id="publicProfileTitle"></p>
      </div>
      <div id="publicProfileContent">
       <div class="grid md:grid-cols-2 gap-8 mb-10">
        <div class="bg-gray-50 p-6 rounded-2xl">
         <h3 class="font-bold text-xl text-gray-800 mb-4">üìû Contact Information</h3>
         <div class="space-y-3">
          <p class="text-gray-700"><span class="font-semibold">Email:</span> <a href="#" id="publicProfileEmail" class="text-purple-600 hover:underline"></a></p>
          <div>
           <p class="text-gray-700 mb-2"><span class="font-semibold">Phone:</span> <a href="#" id="publicProfilePhone" class="text-purple-600 hover:underline"></a></p>
           <div class="contact-actions" id="publicProfileContactActions"><!-- Contact buttons will be added here -->
           </div>
          </div>
          <p class="text-gray-700"><span class="font-semibold">Company:</span> <span id="publicProfileCompany"></span></p>
         </div>
        </div>
        <div class="bg-gray-50 p-6 rounded-2xl">
         <h3 class="font-bold text-xl text-gray-800 mb-4">‚ÑπÔ∏è About</h3>
         <p class="text-gray-700" id="publicProfileAbout"></p>
        </div>
       </div>
       <div id="publicProfileSocialLinks" class="mb-10"><!-- Social links will be added here -->
       </div>
       <div class="text-center"><a href="#" class="btn btn-primary text-lg" id="saveContactBtn">üíæ Save Contact</a>
       </div>
      </div>
      <div id="publicProfileError" style="display: none;" class="text-center py-10">
       <div class="text-6xl mb-4">
        ‚ùå
       </div>
       <h3 class="text-2xl font-bold text-gray-800 mb-2">Profile Not Found</h3>
       <p class="text-gray-600 mb-6">This user profile doesn't exist or has been removed.</p><a href="/" class="btn btn-primary" data-route="/">‚Üê Back to Home</a>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Change Password -->
  <div id="change-password" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a><button class="btn btn-danger" onclick="handleSignOut()">Sign Out</button>
    </div>
   </nav>
   <div class="max-w-2xl mx-auto px-4 py-10">
    <div class="card p-10">
     <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Update Your Password</h2>
     <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
      <div class="mb-6"><label for="currentPassword" class="block text-gray-700 mb-2 font-semibold">Current Password</label> <input type="password" id="currentPassword" class="input-field" required>
      </div>
      <div class="mb-6"><label for="newPassword" class="block text-gray-700 mb-2 font-semibold">New Password</label> <input type="password" id="newPassword" class="input-field" required minlength="6">
       <p class="text-sm text-gray-500 mt-2">Minimum 6 characters</p>
      </div>
      <div class="mb-8"><label for="confirmPassword" class="block text-gray-700 mb-2 font-semibold">Confirm New Password</label> <input type="password" id="confirmPassword" class="input-field" required>
      </div>
      <div class="flex gap-6 justify-center"><button type="submit" class="btn btn-primary text-lg" id="changePasswordBtn"> <span id="changePasswordBtnText">üîê Update Password</span> <span id="changePasswordBtnLoading" style="display: none;"><span class="loading"></span></span> </button> <a href="/profile" class="btn btn-secondary text-lg" data-route="/profile">Cancel</a>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Admin Dashboard -->
  <div id="admin" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <div class="flex gap-4"><a href="/company-management" class="btn btn-primary" data-route="/company-management">üè¢ Company Management</a> <button class="btn btn-secondary" onclick="openSubAdminModal()">‚ûï Register Sub-Admin</button> <button class="btn btn-secondary" onclick="showPage('change-password')">üîí Change Password</button> <button class="btn btn-danger" onclick="handleSignOut()">Sign Out</button>
     </div>
    </div>
   </nav>
   <div class="max-w-7xl mx-auto px-4 py-10"><!-- Stats Dashboard -->
     <div class="grid md:grid-cols-4 gap-6 mb-10">
     <div class="stat-card" onclick="setFilter('all')" style="cursor:pointer">
      <div class="text-5xl mb-3">
       üë•
      </div>
      <p class="text-4xl font-bold mb-2" id="adminTotalUsers">0</p>
      <p class="text-lg opacity-90">Total Users</p>
     </div>
     <div class="stat-card" onclick="setFilter('trial')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); cursor:pointer">
      <div class="text-5xl mb-3">
       üéØ
      </div>
      <p class="text-4xl font-bold mb-2" id="adminTrialUsers">0</p>
      <p class="text-lg opacity-90">Trial Users</p>
     </div>
     <div class="stat-card" onclick="setFilter('approved')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor:pointer">
      <div class="text-5xl mb-3">
       ‚úÖ
      </div>
      <p class="text-4xl font-bold mb-2" id="adminApprovedUsers">0</p>
      <p class="text-lg opacity-90">Approved</p>
     </div>
     <div class="stat-card" onclick="setFilter('pending')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor:pointer">
      <div class="text-5xl mb-3">
       &#9203;
      </div>
      <p class="text-4xl font-bold mb-2" id="adminPendingUsers">0</p>
      <p class="text-lg opacity-90">Pending</p>
     </div>
    </div><!-- Users Management Section -->
    <div class="card p-8">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">üìã Activity Logs</h2>
      <div class="flex gap-3"><button class="btn btn-primary" onclick="exportActivityLogs()">üì• Export Logs</button><button class="btn btn-danger" onclick="clearActivityLogs()">üóëÔ∏è Clear Logs</button></div>
     </div>
     <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
      <table class="table">
       <thead style="position: sticky; top: 0; z-index: 10;">
        <tr>
         <th>Timestamp</th>
         <th>User</th>
         <th>Activity</th>
         <th>Details</th>
        </tr>
       </thead>
       <tbody id="activityLogsTable">
        <tr>
         <td colspan="4" class="text-center text-gray-500 py-10">No activity logs yet</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- Activity Logs Section moved to bottom -->
    <div class="card p-8 mb-10">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-bold text-gray-800">All Registered Users</h2>
      <div class="flex gap-3"><button class="btn btn-primary" onclick="exportUsersToCSV()">üì• Export to CSV</button><button class="btn btn-secondary" onclick="refreshAdminUsers()">üîÑ Refresh</button></div>
     </div><!-- Search Bar -->
     <div class="mb-6"><label for="adminSearchInput" class="block text-gray-700 mb-2 font-semibold">üîç Search Users</label> <input type="text" id="adminSearchInput" class="input-field" placeholder="Search by name, email, or username..." oninput="filterUsers()">
     </div><!-- Filter Buttons -->
     <div class="mb-8"><label class="block text-gray-700 mb-3 font-semibold">üéØ Filter by Status</label>
      <div class="flex flex-wrap gap-3"><button class="filter-btn active" data-filter="all" onclick="setFilter('all')"> All Users <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countAll">0</span> </button> <button class="filter-btn" data-filter="trial" onclick="setFilter('trial')"> Trial <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countTrial">0</span> </button> <button class="filter-btn" data-filter="pending" onclick="setFilter('pending')"> Pending Payment <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countPending">0</span> </button> <button class="filter-btn" data-filter="approved" onclick="setFilter('approved')"> Approved <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countApproved">0</span> </button> <button class="filter-btn" data-filter="expired" onclick="setFilter('expired')"> Expired <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countExpired">0</span> </button> <button class="filter-btn" data-filter="deleted" onclick="setFilter('deleted')"> Deleted <span class="ml-2 px-2 py-1 bg-white bg-opacity-30 rounded-full text-sm" id="countDeleted">0</span> </button> <button class="filter-btn" data-filter="subadmin" onclick="setFilter('subadmin')"> Sub‚ÄëAdmins </button>
      </div>
     </div>
     <div class="overflow-x-auto">
      <table class="table">
       <thead>
        <tr>
         <th>Name</th>
         <th>Email</th>
         <th>Username</th>
         <th>Status</th>
         <th>Joined Date</th>
         <th>Actions</th>
        </tr>
       </thead>
       <tbody id="adminUserTable">
        <tr>
         <td colspan="7" class="text-center text-gray-500 py-10">No users registered yet</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
  </div>
  <div id="company-management" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <div class="flex gap-4"><button class="btn btn-primary" onclick="showBulkOrderModal()">üì¶ Request Bulk Order</button> <a href="/admin" class="btn btn-secondary" data-route="/admin">‚¨ÖÔ∏è Back to Admin</a></div>
    </div>
   </nav>
   <div class="max-w-7xl mx-auto px-4 py-10">
    <div class="card p-8 mb-6">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-bold text-gray-800">Overview</h2>
     </div>
     <div class="grid md:grid-cols-4 gap-6">
      <div class="card p-6 text-center"><div class="text-sm text-gray-600">Total Companies</div><div id="companyTotalCount" class="text-3xl font-bold">0</div></div>
      <div class="card p-6 text-center"><div class="text-sm text-gray-600">Total Employees</div><div id="companyTotalEmployees" class="text-3xl font-bold">0</div></div>
      <div class="card p-6 text-center"><div class="text-sm text-gray-600">Approved Employees</div><div id="companyApprovedEmployees" class="text-3xl font-bold">0</div></div>
      <div class="card p-6 text-center"><div class="text-sm text-gray-600">Pending/Expired</div><div id="companyPendingExpired" class="text-3xl font-bold">0</div></div>
     </div>
    </div>
    <div class="card p-8 mb-6">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-bold text-gray-800">Company Tools</h2>
      <div class="flex gap-3">
        <button class="btn btn-secondary" onclick="autoAssignAllByDomain()">‚öôÔ∏è Auto-Assign by Domain (All)</button>
        <button class="btn btn-secondary" onclick="exportCompaniesToCSV()">üì• Export Companies</button>
      </div>
     </div>
     <div>
      <p class="text-gray-600">Use these tools to manage companies at scale. Auto-assign scans all users and assigns them to companies based on email domains.</p>
     </div>
    </div>
    <div class="card p-8 mb-6">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-bold text-gray-800">Companies Missing Domain</h2>
     </div>
     <div id="missingDomainsList" class="grid md:grid-cols-2 gap-4"></div>
    </div>
    <div class="card p-8 mb-6">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-bold text-gray-800">Companies</h2>
      <div class="flex gap-3">
        <input id="companySearchInput" class="input-field" placeholder="Search companies">
        <button class="btn btn-primary" onclick="openCreateCompanyModal()">‚ûï Create Company</button>
        <button class="btn btn-secondary" onclick="renderCompanyList()">üîÑ Refresh</button>
      </div>
     </div>
     <div id="companyList" class="grid md:grid-cols-3 gap-6"></div>
    </div>
   </div>
  </div>
  <div id="company-detail" class="page">
   <nav class="gradient-bg p-4 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <a href="/" data-home="true" class="text-white text-3xl font-bold inline-flex items-center gap-3"><img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:40px;"> <span>DuoBuddy</span></a>
     <span id="companyDetailTitle" class="text-white text-2xl font-bold ml-6"></span>
     <div class="flex gap-4"><button class="btn btn-primary" onclick="showBulkOrderModal()">üì¶ Request Bulk Order</button> <a href="/company-management" class="btn btn-secondary" data-route="/company-management">‚¨ÖÔ∏è Back to Companies</a></div>
    </div>
   </nav>
   <div class="max-w-7xl mx-auto px-4 py-10">
    <div class="card p-8 mb-6">
     <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-2xl font-bold text-gray-800">Company Settings</h2>
      <div class="flex gap-3">
       <button class="btn btn-secondary" onclick="openEditCompanyModal(document.getElementById('companyDetailTitle').textContent.replace(/^üè¢\\s*/, ''))">üõ†Ô∏è Edit Company</button>
       <button class="btn btn-secondary" onclick="openAssignEmployeesModal(document.getElementById('companyDetailTitle').textContent.replace(/^üè¢\\s*/, ''))">Assign Employees</button>
       <button class="btn btn-secondary" onclick="autoAssignByDomain(document.getElementById('companyDetailTitle').textContent.replace(/^üè¢\\s*/, ''))">Auto-Assign by Domain</button>
       <button class="btn btn-primary" onclick="exportCompanyEmployees(document.getElementById('companyDetailTitle').textContent.replace(/^üè¢\\s*/, ''))">Export Employees</button>
      </div>
     </div>
     <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div><label class="block text-gray-700 mb-2 font-semibold">Domain</label><input id="companySettingsDomain" class="input-field" placeholder="example.com"></div>
      <div><label class="block text-gray-700 mb-2 font-semibold">Primary Color</label><input id="companySettingsColor" class="input-field" placeholder="#1E3A8A"></div>
     </div>
     <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div><label class="block text-gray-700 mb-2 font-semibold">Logo URL</label><input id="companySettingsLogo" class="input-field" placeholder="https://..."></div>
      <div><label class="block text-gray-700 mb-2 font-semibold">Billing Name</label><input id="companySettingsBillingName" class="input-field"></div>
     </div>
     <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div><label class="block text-gray-700 mb-2 font-semibold">Billing Email</label><input id="companySettingsBillingEmail" class="input-field" placeholder="billing@example.com"></div>
      <div><label class="block text-gray-700 mb-2 font-semibold">Billing Phone</label><input id="companySettingsBillingPhone" class="input-field" placeholder="+60 12-345 6789"></div>
     </div>
     <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="md:col-span-2"><label class="block text-gray-700 mb-2 font-semibold">Address</label><input id="companySettingsAddress" class="input-field"></div>
     </div>
     <div class="mb-6"><label class="block text-gray-700 mb-2 font-semibold">Notes</label><textarea id="companySettingsNotes" class="input-field" rows="3" placeholder="Internal notes"></textarea></div>
     <div class="flex gap-4 justify-center">
      <button class="btn btn-primary" onclick="handleSaveCompanySettings(document.getElementById('companyDetailTitle').textContent.replace(/^üè¢\\s*/, ''))">Save Settings</button>
     </div>
    </div>
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">Employees</h2>
     <div id="companyEmployees" class="overflow-x-auto">
      <table class="table">
       <thead>
        <tr>
         <th>Name</th>
         <th>Email</th>
         <th>Username</th>
         <th>Status</th>
         <th>Actions</th>
        </tr>
       </thead>
       <tbody id="companyEmployeesTable">
        <tr><td colspan="5" class="text-center text-gray-500 py-10">No employees found</td></tr>
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div>
 </div><!-- Admin User Management Modal -->

  <div id="subAdminModal" style="display: none;">
   <div class="modal-overlay" onclick="closeSubAdminModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
     <div class="p-10">
      <div class="text-center mb-8">
       <div class="text-6xl mb-4">üë•</div>
       <h3 class="text-4xl font-bold text-gray-800 mb-2">Register Sub-Admin</h3>
      </div>
      <form id="subAdminForm" onsubmit="handleRegisterSubAdmin(event)">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div><label class="block text-gray-700 mb-2 font-semibold">Full Name</label><input type="text" id="subAdminName" class="input-field" required></div>
          <div><label class="block text-gray-700 mb-2 font-semibold">Username</label><input type="text" id="subAdminUsername" class="input-field" required></div>
        </div>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div><label class="block text-gray-700 mb-2 font-semibold">Email</label><input type="email" id="subAdminEmail" class="input-field" required></div>
          <div><label class="block text-gray-700 mb-2 font-semibold">Phone</label><input type="text" id="subAdminPhone" class="input-field" placeholder="+60 12-345 6789"></div>
        </div>
        <div class="mb-6"><label class="block text-gray-700 mb-2 font-semibold">Password</label><input type="password" id="subAdminPassword" class="input-field" required minlength="7"></div>
        <button type="submit" class="btn btn-primary w-full">‚úÖ Create Sub-Admin</button>
      </form>
      <div class="mt-4 text-center"><button class="btn btn-secondary" onclick="closeSubAdminModal()">Close</button></div>
     </div>
    </div>
   </div>
  </div>
  <div id="createCompanyModal" style="display: none;">
    <div class="modal-overlay" onclick="closeCreateCompanyModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üè¢</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Create Company</h3>
          </div>
          <form id="createCompanyForm" onsubmit="handleCreateCompany(event)">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Company Name *</label><input type="text" id="companyName" class="input-field" required></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Primary Color</label><input type="text" id="companyColor" class="input-field" placeholder="#1E3A8A"></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Domain</label><input type="text" id="companyDomain" class="input-field" placeholder="example.com"></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Logo URL</label><input type="url" id="companyLogo" class="input-field" placeholder="https://..."></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Contact Name</label><input type="text" id="companyBillingName" class="input-field"></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Contact Email</label><input type="email" id="companyBillingEmail" class="input-field" placeholder="billing@example.com"></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Contact Phone</label><input type="text" id="companyBillingPhone" class="input-field" placeholder="+60 12-345 6789"></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Address</label><input type="text" id="companyAddress" class="input-field"></div>
            </div>
            <div class="mb-6"><label class="block text-gray-700 mb-2 font-semibold">Notes</label><textarea id="companyNotes" class="input-field" rows="3" placeholder="Internal notes"></textarea></div>
            <div class="flex gap-4 justify-center">
              <button type="submit" class="btn btn-primary text-lg px-8">Create</button>
              <button type="button" class="btn btn-secondary text-lg px-8" onclick="closeCreateCompanyModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id="editCompanyModal" style="display: none;">
    <div class="modal-overlay" onclick="closeEditCompanyModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üõ†Ô∏è</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Edit Company</h3>
            <p class="text-gray-600">Company: <span id="editCompanyTitle"></span></p>
          </div>
          <form id="editCompanyForm" onsubmit="handleUpdateCompany(event)">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Domain</label><input type="text" id="editCompanyDomain" class="input-field" placeholder="example.com"></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Primary Color</label><input type="text" id="editCompanyColor" class="input-field" placeholder="#1E3A8A"></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Logo URL</label><input type="url" id="editCompanyLogo" class="input-field" placeholder="https://..."></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Name</label><input type="text" id="editCompanyBillingName" class="input-field"></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Email</label><input type="email" id="editCompanyBillingEmail" class="input-field" placeholder="billing@example.com"></div>
              <div><label class="block text-gray-700 mb-2 font-semibold">Billing Phone</label><input type="text" id="editCompanyBillingPhone" class="input-field" placeholder="+60 12-345 6789"></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div class="md:col-span-2"><label class="block text-gray-700 mb-2 font-semibold">Address</label><input type="text" id="editCompanyAddress" class="input-field"></div>
            </div>
            <div class="mb-6"><label class="block text-gray-700 mb-2 font-semibold">Notes</label><textarea id="editCompanyNotes" class="input-field" rows="3" placeholder="Internal notes"></textarea></div>
            <div class="flex gap-4 justify-center">
              <button type="submit" class="btn btn-primary text-lg px-8">Save Changes</button>
              <button type="button" class="btn btn-secondary text-lg px-8" onclick="closeEditCompanyModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id="assignEmployeesModal" style="display: none;">
    <div class="modal-overlay" onclick="closeAssignEmployeesModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üë•</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Assign Employees</h3>
            <p class="text-gray-600">Company: <span id="assignEmployeesTitle"></span></p>
          </div>
          <div id="assignEmployeesList"></div>
          <div class="mt-6 flex gap-4 justify-center">
            <button class="btn btn-secondary" onclick="autoAssignByDomain(document.getElementById('assignEmployeesTitle').textContent)">Auto Assign by Domain</button>
            <button class="btn btn-primary" onclick="closeAssignEmployeesModal()">Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="adminUserModal" style="display: none;">
   <div class="modal-overlay" onclick="closeAdminUserModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
     <div class="p-10">
      <div class="text-center mb-8">
       <div class="text-6xl mb-4">
        üë§
       </div>
       <h3 class="text-4xl font-bold text-gray-800 mb-2" id="adminModalUserName">User Management</h3>
       <p class="text-gray-600 text-lg" id="adminModalUserEmail"></p>
      </div><!-- View Payment Proof Section -->
      <div class="card p-8 mb-6 bg-gradient-to-r from-purple-50 to-blue-50" id="adminPaymentProofSection" style="display: none;">
       <h4 class="text-2xl font-bold text-gray-800 mb-4">üì∑ Payment Proof</h4>
       <div class="flex items-center gap-3 mb-3">
         <img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765881051/Maybank_khnr4o.png" alt="Maybank" style="height:36px;">
         <span class="text-gray-700 font-semibold">Maybank</span>
       </div>
       <div class="text-center"><img id="adminPaymentProofImage" src="" alt="Payment Proof" style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 16px;" onerror="this.style.display='none';">
        <p id="adminNoPaymentProof" class="text-gray-600">No payment proof uploaded</p>
       </div>
      </div>
      <div class="card p-8 mb-6 bg-gradient-to-r from-indigo-50 to-cyan-50" id="adminBackQrSection" style="display: none;">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üîó Back QR Selection</h4>
        <p class="text-gray-700 mb-2" id="adminBackQrInfo"></p>
        <div class="text-center">
          <img id="adminBackQrImage" src="" alt="Back QR" style="max-width: 220px; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 16px; display:none;">
          <a id="adminBackQrLink" href="#" target="_blank" class="btn btn-secondary" style="display:none;">Open QR Link</a>
        </div>
      </div>
      <div class="card p-8 mb-6 bg-gradient-to-r from-gray-50 to-slate-100" id="adminAssetsSection" style="display: none;">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üìÅ User Card Assets</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <p class="text-gray-700 mb-2">Design Image</p>
            <img id="adminDesignImagePreview" src="" alt="Design" style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 8px; display:none;">
            <a id="adminDesignImageDownload" href="#" download="design.png" class="btn btn-secondary" style="display:none;">Download Design</a>
          </div>
          <div>
            <p class="text-gray-700 mb-2">Payment Proof</p>
            <a id="adminPaymentProofDownload" href="#" download="payment_proof.png" class="btn btn-secondary" style="display:none;">Download Payment Proof</a>
          </div>
        </div>
      </div><!-- Approve Payment Section -->
      <div class="card p-8 mb-6 bg-gradient-to-r from-green-50 to-emerald-50">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üí≥ Approve Payment &amp; Upload Card Details</h4>
        <div class="flex items-center gap-3 mb-3">
          <img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765881051/Maybank_khnr4o.png" alt="Maybank" style="height:36px;">
          <span class="text-gray-700 font-semibold">Maybank</span>
        </div>
        <form id="approvePaymentForm" onsubmit="handleApprovePayment(event)">
        <p id="adminCardCountText" class="text-sm text-gray-600 mb-2"></p>
        <div class="mb-4"><label for="approveCardSlot" class="block text-gray-700 mb-2 font-semibold">Card Slot Number *</label> <input type="number" id="approveCardSlot" class="input-field" min="1" max="10" placeholder="Enter slot number (1-10)" required>
        </div>
        <div class="mb-4"><label for="adminCardDesignUpload" class="block text-gray-700 mb-2 font-semibold">Upload Card Design Image</label>
         <div class="text-center"><img id="adminCardDesignPreview" style="display: none; max-width: 300px; height: auto; border-radius: 12px; margin: 0 auto 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" alt="Card Design">
          <div class="mb-3"><label for="adminCardDesignUpload" class="btn btn-primary cursor-pointer">üì∑ Upload Card Design</label> <input type="file" id="adminCardDesignUpload" accept="image/*" style="display: none;" onchange="handleAdminCardDesignUpload(event)"> <button type="button" class="btn btn-secondary ml-4" onclick="removeAdminCardDesign()" id="removeAdminCardDesignBtn" style="display: none;">üóëÔ∏è Remove</button>
          </div>
          <p class="text-sm text-gray-500">JPG, PNG or GIF (Max 5MB)</p>
         </div>
        </div>
        <div class="mb-4"><label for="adminNfcSerial" class="block text-gray-700 mb-2 font-semibold">NFC Serial Number</label> <input type="text" id="adminNfcSerial" class="input-field" placeholder="Enter NFC serial number">
        </div>
        <div class="mb-4"><label for="adminNfcPassword" class="block text-gray-700 mb-2 font-semibold">NFC Lock Password</label> <input type="text" id="adminNfcPassword" class="input-field" placeholder="Enter NFC lock password">
        </div><button type="submit" class="btn btn-primary w-full">‚úÖ Approve &amp; Activate Card</button>
        </form>
        <div class="mt-4">
          <button class="btn btn-danger w-full" onclick="handleAdminDeleteCard()">üóëÔ∏è Delete Card Slot (Reset Order)</button>
        </div>
      </div><!-- Reset Password Section -->
      <div class="card p-8 mb-6 bg-gradient-to-r from-yellow-50 to-amber-50" id="subAdminApprovalSection" style="display:none;">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üë• Sub-Admin Profile Approval</h4>
        <p class="text-gray-700 mb-4">Approve this sub-admin's profile to activate their access.</p>
        <button class="btn btn-primary w-full" onclick="handleApproveSubAdminProfile()">‚úÖ Approve Profile</button>
      </div>
      <div class="card p-8 mb-6 bg-gradient-to-r from-yellow-50 to-amber-50">
       <h4 class="text-2xl font-bold text-gray-800 mb-4">‚úâÔ∏è Change Login Email</h4>
       <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div><label class="block text-gray-700 mb-2 font-semibold">Current</label><input type="text" id="adminCurrentEmail" class="input-field" disabled></div>
        <div><label class="block text-gray-700 mb-2 font-semibold">New Email</label><input type="email" id="adminNewEmail" class="input-field" placeholder="user@example.com"></div>
       </div>
       <button class="btn btn-primary w-full" onclick="handleAdminChangeEmail()">üîÑ Update Login Email</button>
      </div>
      <div class="card p-8 mb-6 bg-gradient-to-r from-blue-50 to-indigo-50">
       <h4 class="text-2xl font-bold text-gray-800 mb-4">üîë Reset Password</h4>
       <form id="adminResetPasswordForm" onsubmit="handleAdminResetPassword(event)">
        <div class="mb-4"><label class="block text-gray-700 mb-2 font-semibold">New Password *</label> <input type="text" id="adminNewPassword" class="input-field" placeholder="Enter new password" required minlength="6">
        </div><button type="submit" class="btn btn-primary w-full">üîê Reset Password</button>
       </form>
      </div><!-- Delete User Section -->
      <div class="card p-8 bg-gradient-to-r from-red-50 to-pink-50" id="adminDeleteUserSection">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üóëÔ∏è Delete User Account</h4>
       <p class="text-gray-600 mb-4">This action cannot be undone. All user data will be permanently deleted.</p>
       <div id="deleteUserConfirm"><button class="btn btn-danger w-full" onclick="showDeleteConfirmation()">‚ö†Ô∏è Delete User Account</button>
       </div>
       <div id="deleteUserFinal" style="display: none;">
        <p class="text-red-600 font-bold mb-4 text-center">Are you sure? This cannot be undone!</p>
        <div class="flex gap-4"><button class="btn btn-danger flex-1" onclick="handleDeleteUser()">‚úÖ Yes, Delete</button> <button class="btn btn-secondary flex-1" onclick="hideDeleteConfirmation()">‚ùå Cancel</button>
        </div>
       </div>
      </div>
      <div class="card p-8 mb-6 bg-gradient-to-r from-sky-50 to-teal-50" id="adminCreateCardSection">
        <h4 class="text-2xl font-bold text-gray-800 mb-4">üìá Create Business Card For User</h4>
        <form id="adminCreateCardForm" onsubmit="handleAdminCreateCard(event)">
          <div class="grid md:grid-cols-3 gap-4 mb-4">
            <div><label class="block text-gray-700 mb-2 font-semibold">Slot</label><input type="number" id="adminCreateSlot" class="input-field" min="1" max="10" value="1" required></div>
            <div><label class="block text-gray-700 mb-2 font-semibold">Design</label><select id="adminCreateDesign" class="input-field"><option>Black Matte Card</option><option>Gold Brushed Card</option><option>Silver Brushed Card</option></select></div>
            <div><label class="block text-gray-700 mb-2 font-semibold">Show Phone on Card</label><input type="checkbox" id="adminCreateShowPhone" class="input-field"></div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div><label class="block text-gray-700 mb-2 font-semibold">Name</label><input type="text" id="adminCreateName" class="input-field" required></div>
            <div><label class="block text-gray-700 mb-2 font-semibold">Phone</label><input type="text" id="adminCreatePhone" class="input-field" required></div>
          </div>
          <div class="grid md:grid-cols-3 gap-4 mb-4">
            <div><label class="block text-gray-700 mb-2 font-semibold">QR Type</label><select id="adminCreateQrType" class="input-field"><option value="none">None</option><option value="whatsapp">WhatsApp</option><option value="profile">Profile Link</option><option value="custom">Custom URL</option></select></div>
            <div class="md:col-span-2"><label class="block text-gray-700 mb-2 font-semibold">QR Text (auto for WhatsApp/Profile)</label><input type="text" id="adminCreateQrText" class="input-field" placeholder="https://..." /></div>
          </div>
          <div class="mb-4"><label class="block text-gray-700 mb-2 font-semibold">Design Image (optional)</label><input type="file" id="adminCreateDesignImage" accept="image/*" class="input-field"></div>
          <button type="submit" class="btn btn-primary w-full">‚úÖ Create Card</button>
        </form>
      </div>
      <div class="mt-8 text-center"><button class="btn btn-secondary text-lg px-8" onclick="closeAdminUserModal()">Close</button>
      </div>
     </div>
    </div>
   </div>
  </div>
  
  <div id="orderCardModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;">
    <div class="modal-overlay" onclick="closeOrderCardModal()">
      <div class="modal-content" onclick="event.stopPropagation()" style="position: relative; z-index: 10001;">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üìá</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Order NFC Business Card</h3>
            <p class="text-gray-600 text-lg">Card Slot <span id="orderCardSlot">1</span> ‚Ä¢ RM 99 per card</p>
          </div>
          <form id="orderCardForm" onsubmit="handleOrderCard(event)">
            <div class="mb-6">
              <label for="orderDesign" class="block text-gray-700 mb-2 font-semibold">Card Design *</label>
              <select id="orderDesign" class="input-field" required onchange="updateCardDesignPreview()">
                <option value="Black Matte Card">Black Matte Card</option>
                <option value="Gold Brushed Card">Gold Brushed Card</option>
                <option value="Silver Brushed Card">Silver Brushed Card</option>
              </select>
        <div class="mt-4">
          <div class="text-sm text-gray-600 mb-2">Design Editor ‚Ä¢ Drag name, phone, logo, QR on canvas</div>
          <div class="mb-3 text-xs text-gray-600">Reminder: Card will be engraved according to card internal colour.</div>
          <div>
            <h4 class="font-bold text-xl text-gray-800 mb-2">Front Card</h4>
            <div class="grid md:grid-cols-2 gap-4 items-start">
              <div>
                <p class="text-sm text-gray-500 mb-1">(Preview)</p>
                <canvas id="cardDesignCanvas" width="430" height="270" style="width:100%; max-width:430px; height:auto; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.15); background:#eee"></canvas>
                <label class="inline-flex items-center gap-2 mt-2 text-gray-700"><input type="checkbox" id="frontShowGrid"> Show grid</label>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">(Doodle Preview)</p>
                <canvas id="frontDoodlePreviewCanvas" width="430" height="270" style="width:100%; max-width:430px; height:auto; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.15); background:#fafafa"></canvas>
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Name Text</label>
                <input id="frontDesignName" class="input-field" placeholder="Your Name" />
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Font</label><select id="frontNameFont" class="input-field"><option>Arial</option><option>Georgia</option><option>Helvetica</option><option>Times New Roman</option></select></div>
                  <div><label class="text-xs text-gray-600">Size</label><input type="number" id="frontNameSize" class="input-field" min="12" max="60" step="1" value="24" /></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Pos X</label><input type="number" id="frontNameX" class="input-field" min="0" max="430" step="1" value="215" /></div>
                  <div><label class="text-xs text-gray-600">Pos Y</label><input type="number" id="frontNameY" class="input-field" min="0" max="270" step="1" value="165" /></div>
                </div>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Resignation (optional)</label>
                <input id="frontResignation" class="input-field" placeholder="e.g. Senior Engineer" />
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Font</label><select id="frontResignFont" class="input-field"><option>Arial</option><option>Georgia</option><option>Helvetica</option><option>Times New Roman</option></select></div>
                  <div><label class="text-xs text-gray-600">Size</label><input type="number" id="frontResignSize" class="input-field" min="10" max="40" step="1" value="14" /></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Pos X</label><input type="number" id="frontResignX" class="input-field" min="0" max="430" step="1" value="215" /></div>
                  <div><label class="text-xs text-gray-600">Pos Y</label><input type="number" id="frontResignY" class="input-field" min="0" max="270" step="1" value="195" /></div>
                </div>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Company (optional)</label>
                <input id="frontCompany" class="input-field" placeholder="e.g. Company Name" />
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Font</label><select id="frontCompanyFont" class="input-field"><option>Arial</option><option>Georgia</option><option>Helvetica</option><option>Times New Roman</option></select></div>
                  <div><label class="text-xs text-gray-600">Size</label><input type="number" id="frontCompanySize" class="input-field" min="10" max="40" step="1" value="16" /></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Pos X</label><input type="number" id="frontCompanyX" class="input-field" min="0" max="430" step="1" value="215" /></div>
                  <div><label class="text-xs text-gray-600">Pos Y</label><input type="number" id="frontCompanyY" class="input-field" min="0" max="270" step="1" value="140" /></div>
                </div>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Phone Number</label>
                <input id="frontPhone" class="input-field" placeholder="0123456789" />
                <div class="flex items-center gap-3 mt-2">
                  <label class="inline-flex items-center gap-2 text-gray-700"><input type="checkbox" id="frontPhoneShow" checked> Show on card</label>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Font</label><select id="frontPhoneFont" class="input-field"><option>Arial</option><option>Georgia</option><option>Helvetica</option><option>Times New Roman</option></select></div>
                  <div><label class="text-xs text-gray-600">Size</label><input type="number" id="frontPhoneSize" class="input-field" min="12" max="50" step="1" value="18" /></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-gray-600">Pos X</label><input type="number" id="frontPhoneX" class="input-field" min="0" max="430" step="1" value="215" /></div>
                  <div><label class="text-xs text-gray-600">Pos Y</label><input type="number" id="frontPhoneY" class="input-field" min="0" max="270" step="1" value="220" /></div>
                </div>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Font</label>
                <select id="frontDesignFont" class="input-field">
                  <option value="Arial">Arial</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Helvetica">Helvetica</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Logo</label>
                <input type="file" id="frontDesignLogoUpload" accept="image/*" class="input-field" onchange="handleDesignLogoUpload(event)" />
                <button type="button" class="btn btn-secondary mt-2" id="removeLogoBtn" onclick="removeFrontLogo()" style="display:none;">üóëÔ∏è Remove Logo</button>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Logo Zoom</label>
                <input type="range" id="frontLogoScale" min="0.1" max="2" step="0.05" value="1" />
              </div>
              <div>
                <label class="inline-flex items-center gap-2 text-gray-700 font-semibold"><input type="checkbox" id="frontRemoveBg" /> Remove white background</label>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Doodle Border</label>
                <input type="file" id="frontDoodleUpload" accept="image/*" class="input-field" />
                <button type="button" class="btn btn-secondary mt-2" id="removeDoodleBtn" onclick="removeFrontDoodle()" style="display:none;">üóëÔ∏è Remove Doodle</button>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">Border Width</label>
                <input type="range" id="frontDoodleWidth" min="6" max="40" step="1" value="16" />
              </div>
            </div>
            <div class="mt-4 text-center">
              <button type="button" class="btn btn-secondary" onclick="saveFrontDesignImage()">üíæ Save Front Preview</button>
              <input type="hidden" id="orderDesignImageData" />
            </div>
          </div>
          <div class="mt-8">
            <h4 class="font-bold text-xl text-gray-800 mb-2">Back Card</h4>
            <p class="text-sm text-gray-500 mb-1">(Preview)</p>
            <canvas id="cardDesignCanvasBack" width="430" height="270" style="width:100%; max-width:430px; height:auto; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.15); background:#eee"></canvas>
            <label class="inline-flex items-center gap-2 mt-2 text-gray-700"><input type="checkbox" id="backShowGrid"> Show grid</label>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">QR Code</label>
                <select id="backQrType" class="input-field">
                  <option value="none">None</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="profile">Profile Preview</option>
                </select>
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">QR Size</label>
                <input type="range" id="backQrSize" min="60" max="160" step="2" value="90" />
              </div>
              <div>
                <label class="block text-gray-700 mb-1 font-semibold">QR Margin</label>
                <input type="range" id="backQrMargin" min="0" max="40" step="1" value="10" />
              </div>
            </div>
            <div class="mt-4 text-center">
              <button type="button" class="btn btn-secondary" onclick="saveBackDesignImage()">üíæ Save Back Preview</button>
            </div>
          </div>
        </div>
            </div>
            <div class="mb-6">
              <label for="orderQuantity" class="block text-gray-700 mb-2 font-semibold">Quantity *</label>
              <select id="orderQuantity" class="input-field" required>
                <option value="1">1 Card - RM 99</option>
                <option value="2">2 Cards - RM 198</option>
                <option value="3">3 Cards - RM 297</option>
                <option value="5">5 Cards - RM 495</option>
              </select>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mb-6">
              <div>
                <label for="orderPostcode" class="block text-gray-700 mb-2 font-semibold">Postcode (Malaysia)</label>
                <input type="text" id="orderPostcode" class="input-field" placeholder="e.g. 47500" maxlength="5" pattern="[0-9]{5}">
              </div>
              <div>
                <label for="orderRegion" class="block text-gray-700 mb-2 font-semibold">Region</label>
                <input type="text" id="orderRegion" class="input-field" placeholder="Auto from postcode" readonly>
              </div>
            </div>
            <div class="mb-6">
              <label for="orderAddress" class="block text-gray-700 mb-2 font-semibold">Shipping Address *</label>
              <textarea id="orderAddress" class="input-field" rows="3" placeholder="Enter your delivery address" required></textarea>
            </div>
            <div class="mb-6">
              <label for="orderNotes" class="block text-gray-700 mb-2 font-semibold">Special Notes (Optional)</label>
              <textarea id="orderNotes" class="input-field" rows="2" placeholder="Any special requests or instructions?"></textarea>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-2xl mb-6">
              <h4 class="font-bold text-xl text-gray-800 mb-3">üí≥ Payment Information</h4>
              <div class="flex items-center gap-3 mb-3">
                <img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765881051/Maybank_khnr4o.png" alt="Maybank" style="height:40px;">
                <span class="text-gray-700 font-semibold">Maybank</span>
              </div>
              <p class="text-gray-700 mb-2"><strong>Bank:</strong> Maybank Berhad</p>
              <p class="text-gray-700 mb-2"><strong>Account Number:</strong> 164810240562</p>
              <p class="text-gray-700 mb-4"><strong>Account Name:</strong> DuoBuddy Enterprise</p>
              <p class="text-sm text-gray-600 mb-4">Please transfer the amount and upload your payment proof below.</p>
            </div>
            <div class="mb-8">
              <label for="paymentProofUpload" class="block text-gray-700 mb-2 font-semibold">Upload Payment Proof *</label>
              <div class="text-center">
                <img id="paymentProofPreview" style="display: none; max-width: 300px; height: auto; border-radius: 12px; margin: 0 auto 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" alt="Payment Proof">
                <div class="mb-3">
                  <input type="file" id="paymentProofUpload" accept="image/*" style="display: none;" onchange="handlePaymentProofUpload(event)">
                  <button type="button" class="btn btn-primary" onclick="document.getElementById('paymentProofUpload').click()">üì∑ Upload Payment Proof</button>
                  <button type="button" class="btn btn-secondary ml-4" onclick="removePaymentProof()" id="removePaymentProofBtn" style="display: none;">&#128465;&#65039; Remove</button>
                </div>
                <p class="text-sm text-gray-500">JPG, PNG or GIF (Max 10MB) - Screenshot of bank transfer</p>
              </div>
            </div>
            <div class="flex gap-4 justify-center">
              <button type="submit" class="btn btn-primary text-lg px-8">üõí Place Order</button>
              <button type="button" class="btn btn-secondary text-lg px-8" onclick="closeOrderCardModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="viewCardModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;">
    <div class="modal-overlay" onclick="closeViewCardModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üé¥</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Card Details</h3>
            <p class="text-gray-600 text-lg">Card Slot <span id="viewCardSlot">1</span></p>
          </div>
          <div class="grid md:grid-cols-2 gap-8">
            <div>
              <h4 class="font-bold text-xl text-gray-800 mb-4">üìÑ Card Information</h4>
              <div class="bg-gray-50 p-6 rounded-2xl space-y-3">
                <p class="text-gray-700"><span class="font-semibold">Design:</span> <span id="viewCardDesign">Classic Black</span></p>
                <p class="text-gray-700"><span class="font-semibold">Quantity:</span> <span id="viewCardQuantity">1</span></p>
                <p class="text-gray-700"><span class="font-semibold">Status:</span> <span id="viewCardStatus">Active</span></p>
              </div>
              <div id="viewCardNfcDetails" style="display: none;" class="mt-6">
                <h4 class="font-bold text-xl text-gray-800 mb-4">üîê NFC Details</h4>
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl space-y-3">
                  <p class="text-gray-700"><span class="font-semibold">Serial Number:</span> <span id="viewNfcSerial" class="font-mono text-sm">Not assigned</span></p>
                  <p class="text-gray-700"><span class="font-semibold">Lock Password:</span> <span id="viewNfcPassword" class="font-mono text-sm">Not assigned</span></p>
                </div>
              </div>
            </div>
            <div>
              <h4 class="font-bold text-xl text-gray-800 mb-4">üé® Card Design Preview</h4>
              <img id="viewCardDesignImage" src="" alt="Card Design" style="display: none; width: 100%; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);" onerror="this.style.display='none';">
              <div id="viewCardDesignPlaceholder" style="width: 100%; height: 250px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-weight: bold; font-size: 18px;">No design image uploaded yet</div>
            </div>
          </div>
          <div class="mt-8 text-center">
            <button class="btn btn-secondary text-lg px-8" onclick="closeViewCardModal()">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="bulkOrderModal" style="display: none;">
    <div class="modal-overlay" onclick="closeBulkOrderModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-10">
          <div class="text-center mb-8">
            <div class="text-6xl mb-4">üè¢</div>
            <h3 class="text-4xl font-bold text-gray-800 mb-2">Request Bulk Order Quote</h3>
            <p class="text-gray-600 text-lg">Fill in your details and we'll contact you within 24 hours</p>
          </div>
          <form id="bulkOrderForm" onsubmit="handleBulkOrderRequest(event)">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div>
                <label for="bulkCompanyName" class="block text-gray-700 mb-2 font-semibold">Company Name *</label>
                <input type="text" id="bulkCompanyName" class="input-field" placeholder="Your Company Ltd" required>
              </div>
              <div>
                <label for="bulkContactPerson" class="block text-gray-700 mb-2 font-semibold">Contact Person *</label>
                <input type="text" id="bulkContactPerson" class="input-field" placeholder="John Doe" required>
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
              <div>
                <label for="bulkEmail" class="block text-gray-700 mb-2 font-semibold">Email Address *</label>
                <input type="email" id="bulkEmail" class="input-field" placeholder="contact@company.com" required>
              </div>
              <div>
                <label for="bulkPhone" class="block text-gray-700 mb-2 font-semibold">Phone Number *</label>
                <input type="tel" id="bulkPhone" class="input-field" placeholder="+60 12-345 6789" required>
              </div>
            </div>
            <div class="mb-6">
              <label for="bulkQuantity" class="block text-gray-700 mb-2 font-semibold">Number of Cards Needed *</label>
              <select id="bulkQuantity" class="input-field" required>
                <option value="">Select quantity range</option>
                <option value="10-25">10-25 Cards (RM 90/card)</option>
                <option value="26-50">26-50 Cards (RM 80/card)</option>
                <option value="51-100">51-100 Cards (RM 70/card)</option>
                <option value="100+">100+ Cards (RM 70/card - Custom pricing available)</option>
              </select>
            </div>
            <div class="mb-8">
              <label for="bulkMessage" class="block text-gray-700 mb-2 font-semibold">Additional Requirements (Optional)</label>
              <textarea id="bulkMessage" class="input-field" rows="4" placeholder="Tell us about your specific needs, timeline, design preferences, etc."></textarea>
            </div>
            <div class="flex gap-4 justify-center">
              <button type="submit" class="btn btn-primary text-lg px-8">üì§ Submit Request</button>
              <button type="button" class="btn btn-secondary text-lg px-8" onclick="closeBulkOrderModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-logo">
        <a href="/" data-home="true" class="inline-flex items-center gap-3">
          <img src="https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765868757/DuoBuddy_fm8lah.png" alt="DuoBuddy" style="height:32px;">
          <span>DuoBuddy</span>
        </a>
      </div>
      <div class="footer-links">
        <span>Reserved by DuoBuddy</span>
        <a href="mailto:enquiry@duobuddy.my">enquiry@duobuddy.my</a>
        <a href="https://wa.me/60108094829" target="_blank" rel="noopener noreferrer">WhatsApp: 0108094829</a>
      </div>
    </div>
  </footer>
  <script>
    const API_BASE = (location.port === '5050' ? '' : ((['localhost','127.0.0.1'].includes(location.hostname)) ? 'http://localhost:5050' : ''));
    function getPublicOrigin(){
      if (location.hostname === 'duobuddy.my') return 'https://duobuddy.my';
      if (['localhost','127.0.0.1'].includes(location.hostname) && location.port !== '5050') return 'http://localhost:5050';
      return location.origin;
    }
    async function apiRequest(path, opts) {
      const o = opts || {};
      const h = o.headers || {};
      const method = (o.method || 'GET').toUpperCase();
      const baseHeaders = { ...h };
      if (method !== 'GET' && method !== 'HEAD') baseHeaders['Content-Type'] = baseHeaders['Content-Type'] || 'application/json';
      return fetch(API_BASE + path, { ...o, credentials: 'include', headers: baseHeaders });
    }
    if (!window.dataSdk) {
      (function(){
        var storeKey = '__duobuddy_store__';
        function read() { try { return JSON.parse(localStorage.getItem(storeKey) || '[]'); } catch(e) { return []; } }
        function write(data) { try { localStorage.setItem(storeKey, JSON.stringify(data)); } catch(e) {} }
        var data = read();
        var handler = null;
        var idSeq = Date.now();
        window.dataSdk = {
          init: async function(h){ handler = h; if (handler && handler.onDataChanged) handler.onDataChanged(data); return { isOk: true }; },
          create: async function(obj){ var o = { ...obj, __backendId: (++idSeq).toString() }; data.push(o); write(data); if (handler && handler.onDataChanged) handler.onDataChanged(data); return { isOk: true, value: o }; },
          update: async function(obj){ var idx = data.findIndex(function(x){ return x.__backendId === obj.__backendId; }); if (idx >= 0) { data[idx] = obj; } else { data.push(obj); } write(data); if (handler && handler.onDataChanged) handler.onDataChanged(data); return { isOk: true, value: obj }; }
        };
      })();
    }
    if (!window.elementSdk) {
      window.elementSdk = {
        init: async function(){ return { isOk: true }; }
      };
    }
    const RESERVED_USERNAMES = ['admin', 'support', 'login', 'signup', 'profile', 'settings', 'help', 'api', 'www'];

    let allUsers = []; let activityLogs = []; let companies = []; let currentUser = null; let isAdmin = false; let isSubAdmin = false;
    let usernameValidationTimeout = null;
    let currentFilter = 'all';
    let currentSearch = '';
    let currentSlideIndex = 0;
    
    const cardDesigns = [
      {
        name: 'Classic Black',
        image: 'https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765870443/Black_eayemv.png',
        description: 'Professional matte finish with elegant black metal card'
      },
      {
        name: 'All Color Options',
        image: 'https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765870443/All_Card_Colour_Options_whkrhv.png',
        description: 'Explore the full palette of premium card colors'
      },
      {
        name: 'Metallic Silver',
        image: 'https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765870444/Silver_arptz2.png',
        description: 'Sleek silver metallic finish for a premium feel'
      },
      {
        name: 'Gold Edition',
        image: 'https://res.cloudinary.com/dfd2jgoj1/image/upload/v1765870443/Gold_Mirror_vievga.png',
        description: 'Luxury gold metallic card for an exclusive touch'
      },
      {
        name: 'Custom Design',
        image: '',
        description: 'Personalized metallic design tailored to your brand'
      }
    ];
    
    function changeSlide(direction) {
      currentSlideIndex += direction;
      if (currentSlideIndex >= cardDesigns.length) currentSlideIndex = 0;
      if (currentSlideIndex < 0) currentSlideIndex = cardDesigns.length - 1;
      updateSlideshow();
    }
    
    function currentSlide(index) {
      currentSlideIndex = index;
      updateSlideshow();
    }
    
    function updateSlideshow() {
      const design = cardDesigns[currentSlideIndex];
      const slideshow = document.getElementById('cardSlideshow');
      const title = document.getElementById('slideTitle');
      const description = document.getElementById('slideDescription');
      const dots = document.getElementById('slideshowDots').children;
      
      if (slideshow) {
        if (design.image) {
          slideshow.innerHTML = `<img src="${design.image}" alt="${design.name}" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;">`;
        } else {
          slideshow.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 48px;">üé¥</div>`;
        }
      }
      if (title) title.textContent = design.name;
      if (description) description.textContent = design.description;
      
      for (let i = 0; i < dots.length; i++) {
        dots[i].style.background = i === currentSlideIndex ? '#3b82f6' : '#d1d5db';
      }
    }
    
    // Auto-advance slideshow
    setInterval(() => {
      if (document.getElementById('homepage').classList.contains('active')) {
        changeSlide(1);
      }
    }, 4000);

    const dataHandler = {
      onDataChanged(data) {
        companies = data.filter(d => d.type === 'company_record');
        activityLogs = data.filter(d => d.type === 'activity_log').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allUsers = data.filter(d => !d.type || d.type === 'user');
        updateAdminDashboard(); updateActivityLogs(); filterUsers(); updateCompanyManagement();
        if (currentUser) {
          const updated = allUsers.find(u => u.__backendId === currentUser.__backendId);
          if (updated) {
            currentUser = updated;
            if (document.getElementById('my-cards').classList.contains('active')) {
              renderCardSlots();
            }
          }
        }
      }
    };

    async function logActivity(activityType, userId, userName, details) {
      if (allUsers.filter(u => u.type === 'activity_log').length >= 999) {
        return;
      }
      
      const log = {
        type: 'activity_log',
        activity_type: activityType,
        user_id: userId || 'system',
        name: userName || 'System',
        details: details,
        timestamp: new Date().toISOString(),
        email: '',
        password: '',
        username: '',
        phone: '',
        is_admin: false,
        data: '',
        deleted: false
      };
      
      await window.dataSdk.create(log);
    }

    async function setupAdmin() {
      const adminExists = allUsers.find(u => u.email === 'admin@admin');
      if (!adminExists) {
        const profileData = {
          jobTitle: 'Administrator',
          company: 'DuoBuddy',
          about: 'System Administrator',
          created: new Date().toISOString()
        };

        const admin = {
          email: 'admin@duobuddy.my',
          password: 'Admin@123!',
          name: 'Administrator',
          username: 'systemadmin',
          phone: '+60 12-000 0000',
          is_admin: true,
          data: JSON.stringify(profileData)
        };

        await window.dataSdk.create(admin);
      }
      
      // Setup pre-installed user Ibrahim
      const ibrahimExists = allUsers.find(u => u.email === 'a@a.com');
      if (!ibrahimExists) {
        const now = new Date();
        const trialEnd = new Date(now);
        trialEnd.setDate(trialEnd.getDate() + 1);
        
        const ibrahimProfileData = {
          jobTitle: '',
          company: '',
          about: '',
          created: now.toISOString(),
          trialEnd: trialEnd.toISOString(),
          cards: []
        };

        const ibrahim = {
          email: 'a@a.com',
          password: '123456',
          name: 'Ibrahim',
          username: 'ibrahim',
          phone: '01135574829',
          is_admin: false,
          data: JSON.stringify(ibrahimProfileData)
        };

        await window.dataSdk.create(ibrahim);
      }
    }

    function normalizeUsername(username) {
      return username.toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function isReservedUsername(username) {
      return RESERVED_USERNAMES.includes(normalizeUsername(username));
    }

    function findSimilarUsernames(username) {
      const normalized = normalizeUsername(username);
      return allUsers.filter(u => u.username && normalizeUsername(u.username) === normalized);
    }

    function generateUsernameSuggestions(base) {
      const suggestions = [];
      const normalized = normalizeUsername(base);
      
      for (let i = 1; i <= 3; i++) {
        const suggestion = normalized + i;
        if (!findSimilarUsernames(suggestion).length && !isReservedUsername(suggestion)) {
          suggestions.push(suggestion);
        }
      }
      
      return suggestions.slice(0, 3);
    }

    async function validateUsername(username, context) {
      clearTimeout(usernameValidationTimeout);
      
      const urlPreview = document.getElementById(context + 'UrlPreview');
      const validation = document.getElementById(context + 'UsernameValidation');
      const suggestions = document.getElementById(context + 'UsernameSuggestions');
      const input = document.getElementById(context === 'signup' ? 'signupUsername' : 'editUsername');
      
      if (urlPreview) urlPreview.textContent = `duobuddy.my/${username || 'username'}`;
      
      if (!username || username.length < 3) {
        validation.innerHTML = '<p class="validation-message warning">‚ö†Ô∏è At least 3 characters required</p>';
        suggestions.innerHTML = '';
        input.classList.remove('success', 'error');
        return false;
      }
      
      if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
        validation.innerHTML = '<p class="validation-message error">‚ùå Only letters, numbers, dots, hyphens allowed</p>';
        suggestions.innerHTML = '';
        input.classList.add('error');
        input.classList.remove('success');
        return false;
      }
      
      usernameValidationTimeout = setTimeout(() => {
        if (isReservedUsername(username)) {
          validation.innerHTML = '<p class="validation-message error">‚ùå Reserved username</p>';
          input.classList.add('error');
          input.classList.remove('success');
          
          const opts = generateUsernameSuggestions(username);
          if (opts.length) {
            suggestions.innerHTML = `
              <p class="text-sm text-gray-600 mt-3 font-semibold">‚ú® Try these instead:</p>
              <div class="flex flex-wrap gap-2 mt-2">
                ${opts.map(s => `<span class="url-suggestion" onclick="applySuggestion('${s}', '${context}')">${s}</span>`).join('')}
              </div>
            `;
          }
          return false;
        }
        
        const similar = findSimilarUsernames(username);
        const isCurrent = context === 'edit' && currentUser && normalizeUsername(currentUser.username) === normalizeUsername(username);
        
        if (similar.length && !isCurrent) {
          validation.innerHTML = '<p class="validation-message error">‚ùå Username already taken</p>';
          input.classList.add('error');
          input.classList.remove('success');
          
          const opts = generateUsernameSuggestions(username);
          if (opts.length) {
            suggestions.innerHTML = `
              <p class="text-sm text-gray-600 mt-3 font-semibold">‚ú® Available alternatives:</p>
              <div class="flex flex-wrap gap-2 mt-2">
                ${opts.map(s => `<span class="url-suggestion" onclick="applySuggestion('${s}', '${context}')">${s}</span>`).join('')}
              </div>
            `;
          }
          return false;
        }
        
        validation.innerHTML = '<p class="validation-message success">‚úÖ Username available!</p>';
        suggestions.innerHTML = '';
        input.classList.add('success');
        input.classList.remove('error');
        return true;
      }, 500);
    }

    function applySuggestion(suggestion, context) {
      const inputId = context === 'signup' ? 'signupUsername' : 'editUsername';
      document.getElementById(inputId).value = suggestion;
      validateUsername(suggestion, context);
    }

    async function initApp() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) return;
      await ensureDefaultCompanies();
      
      
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig: {},
          onConfigChange: async (config) => {},
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: () => new Map()
        });
      }
      const observer = ('IntersectionObserver' in window) ? new IntersectionObserver((entries) => {
        entries.forEach((entry) => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
      }, { threshold: 0.15 }) : null;
      document.querySelectorAll('.reveal').forEach((el) => { if (observer) { observer.observe(el); } else { el.classList.add('visible'); } });
      try { const r = await apiRequest('/api/users/me', { method: 'GET' }); if (r.ok) { const me = await r.json(); if (me && me.user) { currentUser = me.user; isAdmin = !!me.user.is_admin; if (isAdmin) { await refreshAdminUsers(); if(!window.__adminPoll){ window.__adminPoll = setInterval(()=>{ const adminPage = document.getElementById('adminToolsPage') || document.getElementById('adminPage'); const isVisible = adminPage && adminPage.classList.contains('active'); if(isVisible) refreshAdminUsers(); }, 10000); } } } } } catch(e) {}
    }
    async function refreshAdminUsers(){
      try{
        const r = await apiRequest('/api/admin/users', { method: 'GET' });
        if (!r.ok) return;
        const data = await r.json();
        allUsers = Array.isArray(data.users) ? data.users : [];
        updateAdminDashboard();
        filterUsers();
        updateCompanyManagement();
      }catch(e){}
    }
    async function ensureDefaultCompanies(){
      try{
        const hasAny = (companies || []).length > 0;
        if (hasAny) return;
        const now = new Date().toISOString();
        const rec = {
          type: 'company_record',
          name: 'DuoBuddy Enterprise',
          color: '#1E3A8A',
          domain: 'duobuddy.my',
          logo: '',
          billingName: 'DuoBuddy Billing',
          billingEmail: 'billing@duobuddy.my',
          billingPhone: '+60 10-809 4829',
          address: 'Kuala Lumpur, Malaysia',
          notes: 'Default seeded company record',
          createdAt: now
        };
        await window.dataSdk.create(rec);
        renderCompanyList();
      }catch(e){}
    }

    function showPage(pageId, username = null) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById(pageId);
      if (!el) { const home = document.getElementById('homepage'); if (home) home.classList.add('active'); return; }
      el.classList.add('active');
      window.scrollTo(0, 0);
      
      if (pageId === 'edit-profile') loadEditProfileForm();
      if (pageId === 'my-cards') renderCardSlots();
      if (pageId === 'public-profile' && username) loadPublicProfile(username);
      if (pageId === 'company-management') renderCompanyList();
      if (pageId === 'company-management') updateCompanyManagement();
      if (pageId === 'profile' && currentUser) loadUserProfile(currentUser);
      
      try {
        const path = pageToPath(pageId, username);
        if (path && location.pathname !== path) {
          history.pushState({ pageId, username }, '', path);
        }
      } catch(e) {}
    }

    async function loadPublicProfile(username) {
      try {
        const r = await apiRequest('/api/profile/' + encodeURIComponent(username), { method: 'GET' });
        if (!r.ok) throw new Error('not found');
        const data = await r.json();
        const user = data.user;
        if (!user) throw new Error('not found');
        document.getElementById('publicProfileContent').style.display = 'block';
        document.getElementById('publicProfileError').style.display = 'none';
        const profileData = user.data ? JSON.parse(user.data) : {};
        const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const avatarEl = document.getElementById('publicProfileAvatar');
        const imgEl = document.getElementById('publicProfileImage');
        avatarEl.textContent = initials;
        if (profileData.profilePicture) { avatarEl.style.display = 'none'; imgEl.src = profileData.profilePicture; imgEl.style.display = 'block'; } else { avatarEl.style.display = 'flex'; imgEl.style.display = 'none'; }
        document.getElementById('publicProfileName').textContent = user.name;
        document.getElementById('publicProfileTitle').textContent = profileData.jobTitle || '';
      const emailEl = document.getElementById('publicProfileEmail');
        const preferredEmail = profileData.useLoginForPreview ? user.email : (profileData.preferredEmail || user.email);
        emailEl.textContent = preferredEmail; emailEl.href = `mailto:${preferredEmail}`;
        const phoneEl = document.getElementById('publicProfilePhone');
        phoneEl.textContent = user.phone; phoneEl.href = `tel:${user.phone}`;
        document.getElementById('publicProfileCompany').textContent = profileData.company || 'N/A';
        document.getElementById('publicProfileAbout').textContent = profileData.about || 'No information provided.';
        renderContactActions('publicProfileContactActions', user.phone, profileData.whatsapp);
        renderSocialLinks('publicProfileSocialLinks', profileData);
      } catch(e) {
        document.getElementById('publicProfileContent').style.display = 'none';
        document.getElementById('publicProfileError').style.display = 'block';
        return;
      }
      const saveBtn = document.getElementById('saveContactBtn');
      saveBtn.onclick = function() {
        const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${user.name}
EMAIL:${preferredEmail}
TEL:${user.phone}
ORG:${profileData.company || ''}
TITLE:${profileData.jobTitle || ''}
NOTE:${profileData.about || ''}
END:VCARD`;
        
        const blob = new Blob([vcard], { type: 'text/vcard' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${user.name.replace(/\s+/g, '_')}.vcf`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('üì± Contact saved!');
      };
    }

    const PAGE_ROUTES = {
      '/': { pageId: 'homepage' },
      '/login': { pageId: 'login' },
      '/signup': { pageId: 'signup' },
      '/admin': { pageId: 'admin' },
      '/company-management': { pageId: 'company-management' },
      '/my-cards': { pageId: 'my-cards' },
      '/profile': { pageId: 'profile' },
      '/edit-profile': { pageId: 'edit-profile' },
      '/change-password': { pageId: 'change-password' }
    };
    function routeFromPath(pathname) {
      if (!pathname || pathname === '/') return { pageId: 'homepage' };
      if (PAGE_ROUTES[pathname]) return PAGE_ROUTES[pathname];
      const m1 = pathname.match(/^\/profile\/(.+)$/);
      if (m1) return { pageId: 'public-profile', username: decodeURIComponent(m1[1]) };
      const m2 = pathname.match(/^\/company\/(.+)$/);
      if (m2) return { pageId: 'company-detail', company: decodeURIComponent(m2[1]) };
      return { pageId: 'homepage' };
    }
    function pageToPath(pageId, username) {
      switch (pageId) {
        case 'homepage': return '/';
        case 'login': return '/login';
        case 'signup': return '/signup';
        case 'admin': return '/admin';
        case 'company-management': return '/company-management';
        case 'company-detail': {
          const name = document.getElementById('companyDetailTitle')?.textContent.replace(/^üè¢\s*/, '') || '';
          return name ? '/company/' + encodeURIComponent(name) : '/company-management';
        }
        case 'public-profile': return username ? '/profile/' + encodeURIComponent(username) : '/';
        case 'my-cards': return '/my-cards';
        case 'profile': return '/profile';
        case 'edit-profile': return '/edit-profile';
        case 'change-password': return '/change-password';
        default: return '/';
      }
    }
    function initRouter() {
      const { pageId, username, company } = routeFromPath(location.pathname);
      if (pageId === 'public-profile' && username) { showPage(pageId, username); return; }
      if (pageId === 'company-detail' && company) { renderCompanyDetail(company); showPage('company-detail'); return; }
      showPage(pageId);
      window.onpopstate = function(ev) {
        const st = ev.state || routeFromPath(location.pathname);
        if (st.pageId === 'public-profile') showPage(st.pageId, st.username);
        else if (st.pageId === 'company-detail') { renderCompanyDetail(st.company || ''); showPage('company-detail'); }
        else showPage(st.pageId || 'homepage');
      };
      // Convert key nav links to real hrefs
      document.querySelectorAll('[data-route]').forEach(function(a){
        const r = a.getAttribute('data-route');
        if (r) a.setAttribute('href', r);
        a.addEventListener('click', function(e){
          e.preventDefault();
          const p = routeFromPath(r);
          if (p.pageId === 'public-profile') showPage(p.pageId, p.username);
          else showPage(p.pageId);
        });
      });
      // Home/logo behavior: go to user home when logged-in
      document.querySelectorAll('[data-home]').forEach(function(a){
        a.setAttribute('href', '/');
        a.addEventListener('click', function(e){
          e.preventDefault();
          if (isAdmin) showPage('admin');
          else if (currentUser) showPage('my-cards');
          else showPage('homepage');
        });
      });
    }

    window.addEventListener('load', () => {
      initRouter();
      const hash = window.location.hash.substring(1);
      if (hash && hash !== 'homepage' && hash !== '') {
        if (hash.startsWith('company=')) {
          const companyName = decodeURIComponent(hash.split('=')[1] || '');
          if (companyName) { renderCompanyDetail(companyName); showPage('company-detail'); }
        } else {
          const username = hash;
          setTimeout(() => { showPage('public-profile', username); }, 1000);
        }
      }
    });
    
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash.substring(1);
      if (hash && hash !== 'homepage' && hash !== '') {
        if (hash.startsWith('company=')) {
          const companyName = decodeURIComponent(hash.split('=')[1] || '');
          if (companyName) { renderCompanyDetail(companyName); showPage('company-detail'); }
        } else {
          const username = hash;
          showPage('public-profile', username);
        }
      }
    });

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="text-3xl">${type === 'success' ? '‚úÖ' : '&#9888;&#65039;'}</div>
          <p class="font-semibold text-lg">${message}</p>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    async function handleSignup(event) {
      event.preventDefault();
      
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const username = document.getElementById('signupUsername').value;
      const password = document.getElementById('signupPassword').value;
      const phone = document.getElementById('signupPhone').value;
      
      if (isReservedUsername(username)) {
        showToast('Username is reserved', 'error');
        return;
      }
      if (!isStrongPassword(password)) {
        showToast('Password too weak: 7+ chars, include special symbol, avoid common patterns', 'error');
        return;
      }
      
      document.getElementById('signupBtnText').style.display = 'none';
      document.getElementById('signupBtnLoading').style.display = 'inline';
      document.getElementById('signupBtn').disabled = true;
      
      try {
        const r = await apiRequest('/api/auth/signup', { method: 'POST', body: JSON.stringify({ name, email, username, password, phone }) });
        document.getElementById('signupBtnText').style.display = 'inline';
        document.getElementById('signupBtnLoading').style.display = 'none';
        document.getElementById('signupBtn').disabled = false;
        if (r.ok) {
          showToast('üéâ Account created! 1-day trial started!');
          document.getElementById('signupForm').reset();
          setTimeout(() => showPage('login'), 1500);
        } else {
          showToast('Failed to create account. Try again.', 'error');
        }
      } catch(e) {
        document.getElementById('signupBtnText').style.display = 'inline';
        document.getElementById('signupBtnLoading').style.display = 'none';
        document.getElementById('signupBtn').disabled = false;
        showToast('Failed to create account. Try again.', 'error');
      }
    }

    function isStrongPassword(pwd){
      if (!pwd || pwd.trim().length < 7) return false;
      if (!/[^A-Za-z0-9]/.test(pwd)) return false;
      const banned = ['123456','654321','1234567','7654321','password','qwerty','123','abc123'];
      return !banned.includes(pwd.toLowerCase());
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      document.getElementById('loginBtnText').style.display = 'none';
      document.getElementById('loginBtnLoading').style.display = 'inline';
      document.getElementById('loginBtn').disabled = true;
      try {
        const r = await apiRequest('/api/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        document.getElementById('loginBtnText').style.display = 'inline';
        document.getElementById('loginBtnLoading').style.display = 'none';
        document.getElementById('loginBtn').disabled = false;
        if (r.ok) {
          const data = await r.json();
          const user = data.user;
          currentUser = user;
          isAdmin = user.is_admin || false;
          isSubAdmin = user.is_subadmin || false;
          showToast(`üéâ Welcome back, ${user.name}!`);
          document.getElementById('loginForm').reset();
          if (isAdmin || isSubAdmin) { setTimeout(() => { showPage('admin'); repositionActivityLogs(); }, 1000); } else { loadUserProfile(user); setTimeout(() => showPage('my-cards'), 1000); }
        } else {
          showToast('Invalid email or password', 'error');
        }
      } catch(e) {
        document.getElementById('loginBtnText').style.display = 'inline';
        document.getElementById('loginBtnLoading').style.display = 'none';
        document.getElementById('loginBtn').disabled = false;
        showToast('Invalid email or password', 'error');
      }
    }

    function updateAccountStatus() {
      if (!currentUser) return;
      
      const profileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      const trialEnd = profileData.trialEnd ? new Date(profileData.trialEnd) : null;
      const now = new Date();
      const banner = document.getElementById('accountStatusBanner');
      const hasActiveCard = (profileData.cards || []).some(c => c.status === 'active' || c.ordered);
      if (profileData.paymentApproved || hasActiveCard) {
        banner.innerHTML = '';
        return;
      }
      
      if (trialEnd && now < trialEnd) {
        const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
        banner.innerHTML = `
          <div class="trial-banner">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h3 class="text-2xl font-bold mb-2">üéâ Free Trial Active</h3>
                <p class="text-lg opacity-90">Your trial ends in <span class="font-bold text-2xl">${daysLeft} day(s)</span>. Order your first card to continue!</p>
              </div>
              <span class="status-badge status-trial">Trial Mode</span>
            </div>
          </div>
        `;
      } else if (trialEnd && now >= trialEnd) {
        banner.innerHTML = `
          <div class="expired-banner">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h3 class="text-2xl font-bold mb-2">‚ö†Ô∏è Trial Expired</h3>
                <p class="text-lg opacity-90">Your free trial has ended. Order a card to reactivate your account!</p>
              </div>
              <span class="status-badge status-expired">Expired</span>
            </div>
          </div>
        `;
      } else {
        banner.innerHTML = '';
      }
    }

    function renderCardSlots() {
      if (!currentUser) return;
      
      updateAccountStatus();
      
      const profileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      const cards = profileData.cards || [];
      
      const container = document.getElementById('cardSlotsContainer');
      container.innerHTML = '';
      
      const activeCount = cards.filter(c => c.ordered).length;
      const totalOwnedText = document.createElement('div');
      totalOwnedText.className = 'text-center text-sm text-gray-600 mb-6';
      totalOwnedText.textContent = `Owned: ${activeCount}/10`;
      const parentCard = document.querySelector('#my-cards .card');
      if (parentCard && !document.getElementById('ownedCounterInserted')) { totalOwnedText.id = 'ownedCounterInserted'; parentCard.insertBefore(totalOwnedText, container); }
      const displaySlots = Math.min(10, activeCount + 1);
      for (let i = 1; i <= displaySlots; i++) {
        const card = cards.find(c => c.slot === i);
        const isActive = card && card.ordered;
        
        const slot = document.createElement('div');
        slot.className = `card-slot ${isActive ? 'active' : ''}`;
        if (!isActive) {
          slot.onclick = (e) => {
            if (e.target.tagName !== 'BUTTON') {
              orderCard(i);
            }
          };
          slot.style.cursor = 'pointer';
        }
        slot.innerHTML = `
          <div class="text-7xl mb-4">${isActive ? '&#127924;' : '‚ûï'}</div>
          <h3 class="text-2xl font-bold mb-3 text-gray-800">Card Slot ${i}</h3>
          <p class="text-gray-600 mb-6 text-lg">${isActive ? '‚úÖ Active Card' : 'üì¶ Available Slot'}</p>
          ${isActive ? `
            <div class="bg-white p-4 rounded-xl mb-4">
              <p class="text-sm text-gray-600"><span class="font-semibold">Design:</span> ${card.design || 'Classic'}</p>
              <p class="text-sm text-gray-600"><span class="font-semibold">Status:</span> Active</p>
            </div>
            <button class="btn btn-secondary" onclick="event.stopPropagation(); viewCard(${i})">üìã View Details</button>
          ` : `
            <button class="btn btn-primary text-lg" onclick="event.stopPropagation(); orderCard(${i})">üõí Order Card - RM 99</button>
          `}
        `;
        
        container.appendChild(slot);
      }
    }

    let currentOrderSlot = null;

    function orderCard(slot) {
      if (!currentUser) return;
      
      currentOrderSlot = slot;
      document.getElementById('orderCardSlot').textContent = slot;
      
      // Reset form and preview
      document.getElementById('orderCardForm').reset();
      drawDoodlePreviewCanvas();
      document.getElementById('paymentProofPreview').style.display = 'none';
      document.getElementById('paymentProofPreview').src = '';
      document.getElementById('removePaymentProofBtn').style.display = 'none';
      
      // Show modal
      const modal = document.getElementById('orderCardModal');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Update design preview
      updateCardDesignPreview();
    }
    
    function closeOrderCardModal() {
      document.getElementById('orderCardModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      document.getElementById('orderCardForm').reset();
      currentOrderSlot = null;
    }
    
    function updateCardDesignPreview() {
      redrawCardDesign();
    }

    let designDoodleImg = null; let designDoodleWidth = 16;
    let frontNameSize = 24; let frontPhoneSize = 18; let frontResignSize = 14; let frontCompanySize = 16;
    let frontNameFont = 'Arial'; let frontPhoneFont = 'Arial'; let frontResignFont = 'Arial'; let frontCompanyFont = 'Arial';
    let frontPhoneShow = true;
    let backQrSize = 90; let backQrMargin = 10;
    const designState = { side: 'front', name: '', font: 'Arial', logo: null, logoScale: 1, namePos: {x: 215, y: 165}, phone: '', phonePos: {x: 215, y: 220}, resignation: '', resignPos: {x: 215, y: 195}, company: '', companyPos: {x: 215, y: 140}, qrType: 'none', qrImg: null, qrPos: {x: 340, y: 180}, activeTool: 'move_name' };
    const designBack = { name: '', font: 'Arial', logo: null, logoScale: 1, namePos: {x: 215, y: 175}, phone: '', phonePos: {x: 215, y: 205}, resignation: '', resignPos: {x: 215, y: 195}, company: '', companyPos: {x: 215, y: 140}, qrType: 'none', qrImg: null, qrPos: {x: 140, y: 180} };

    function redrawCardDesign() {
      const canvas = document.getElementById('cardDesignCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const design = document.getElementById('orderDesign').value;
      designState.side = document.getElementById('designSide').value;
      designState.name = document.getElementById('designName').value || '';
      designState.font = document.getElementById('designFont').value || 'Arial';
      designState.logoScale = parseFloat(document.getElementById('designLogoScale').value || '1');
      const removeBg = document.getElementById('designRemoveBg').checked;
      
      // Background
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (design === 'Black Matte Card') {
        ctx.fillStyle = '#111827';
        ctx.fillRect(0,0,canvas.width,canvas.height);
      } else if (design === 'Gold Brushed Card') {
        const grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grd.addColorStop(0,'#b58900'); grd.addColorStop(1,'#d9a441');
        ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      } else {
        const grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grd.addColorStop(0,'#9CA3AF'); grd.addColorStop(1,'#D1D5DB');
        ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      if (designDoodleImg) {
        ctx.save();
        ctx.beginPath();
        ctx.rect(0,0,canvas.width,canvas.height);
        ctx.rect(designDoodleWidth, designDoodleWidth, canvas.width - designDoodleWidth*2, canvas.height - designDoodleWidth*2);
        ctx.clip('evenodd');
        ctx.drawImage(designDoodleImg, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      }
      
      // No-edit zone on back (right half)
      if (designState.side === 'back') {
        ctx.fillStyle = 'rgba(0,0,0,0.08)';
        ctx.fillRect(canvas.width/2, 0, canvas.width/2, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '12px Arial';
        ctx.fillText('NO EDIT', canvas.width*0.75-30, 20);
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(canvas.width*0.75, canvas.height*0.5, 30, 0, Math.PI*2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(canvas.width*0.75-20, canvas.height*0.5-20);
        ctx.lineTo(canvas.width*0.75+20, canvas.height*0.5+20);
        ctx.stroke();
      }
      
      // Draw name text
      ctx.fillStyle = design === 'Black Matte Card' ? '#ffffff' : '#111827';
      ctx.font = `24px ${designState.font}`;
      ctx.textAlign = 'center'; ctx.fillText(designState.name || '', designState.namePos.x, designState.namePos.y);

      // Phone text
      ctx.font = `18px ${designState.font}`;
      ctx.fillText(designState.phone || '', designState.phonePos.x, designState.phonePos.y);
      
      // Draw logo if loaded
      if (designState.logo) {
        const img = designState.logo;
        const targetW = 120 * designState.logoScale;
        const targetH = (img.height/img.width) * targetW;
        let dx = (designState.logoPos ? designState.logoPos.x : canvas.width*0.5) - targetW/2;
        let dy = (designState.logoPos ? designState.logoPos.y : canvas.height*0.25) - targetH/2;
        // If back side, ensure logo stays on left half
        if (designState.side === 'back' && dx + targetW > canvas.width/2) dx = canvas.width/2 - targetW - 10;
        if (removeBg) {
          // Simple white background removal via offscreen canvas threshold
          const off = document.createElement('canvas'); off.width = img.width; off.height = img.height;
          const octx = off.getContext('2d'); octx.drawImage(img,0,0);
          const imgData = octx.getImageData(0,0,off.width,off.height);
          const d = imgData.data; for (let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; if (r>240 && g>240 && b>240) d[i+3]=0; }
          octx.putImageData(imgData,0,0);
          ctx.drawImage(off, dx, dy, targetW, targetH);
        } else {
          ctx.drawImage(img, dx, dy, targetW, targetH);
        }
      }

      // Draw QR if available
      if (designState.qrImg) {
        const size = 90;
        let dx = designState.qrPos.x - size/2;
        let dy = designState.qrPos.y - size/2;
        if (designState.side === 'back' && dx + size > canvas.width/2) dx = canvas.width/2 - size - 10;
        ctx.drawImage(designState.qrImg, dx, dy, size, size);
      }

      const backCanvas = document.getElementById('cardDesignCanvasBack');
      if (backCanvas) {
        const prevSide = designState.side;
        designState.side = 'back';
        const bctx = backCanvas.getContext('2d');
        const tmp = canvas.cloneNode();
        const dataURL = canvas.toDataURL();
        const img = new Image();
        img.onload = () => { bctx.clearRect(0,0,backCanvas.width,backCanvas.height); bctx.drawImage(img,0,0,backCanvas.width,backCanvas.height); };
        img.src = dataURL;
        designState.side = prevSide;
      }
    }

    function handleDesignLogoUpload(e){
      const file = e.target.files && e.target.files[0]; if (!file) return;
      const reader = new FileReader(); reader.onload = () => { const img = new Image(); img.onload = () => { designState.logo = img; redrawCardDesign(); }; img.src = reader.result; }; reader.readAsDataURL(file);
      const btn = document.getElementById('removeLogoBtn'); if (btn) btn.style.display = 'inline-block';
    }

    function saveFrontDesignImage(){
      const canvas = document.getElementById('cardDesignCanvas'); if (!canvas) return;
      document.getElementById('orderDesignImageData').value = canvas.toDataURL('image/png');
      showToast('Front preview saved');
    }
    function saveBackDesignImage(){
      const canvas = document.getElementById('cardDesignCanvasBack'); if (!canvas) return;
      document.getElementById('orderDesignImageData').value = canvas.toDataURL('image/png');
      showToast('Back preview saved');
    }

    // Dragging setup
    (function initDesignDragging(){
      const canvas = document.getElementById('cardDesignCanvas'); if(!canvas) return;
      let dragging = false; let dragTarget = null;
      function pickTarget(x,y){
        const ctx = canvas.getContext('2d');
        // Name
        ctx.font = `${frontNameSize}px ${frontNameFont}`; ctx.textAlign='center';
        const nameW = ctx.measureText(designState.name||'').width; const nameH = frontNameSize;
        const nameRect = {x: designState.namePos.x - nameW/2, y: designState.namePos.y - nameH, w: nameW, h: nameH};
        if (x>=nameRect.x && x<=nameRect.x+nameRect.w && y>=nameRect.y && y<=nameRect.y+nameRect.h) return 'namePos';
        // Phone
        ctx.font = `${frontPhoneSize}px ${frontPhoneFont}`;
        const phoneW = ctx.measureText(designState.phone||'').width; const phoneH = frontPhoneSize;
        const phoneRect = {x: designState.phonePos.x - phoneW/2, y: designState.phonePos.y - phoneH, w: phoneW, h: phoneH};
        if (x>=phoneRect.x && x<=phoneRect.x+phoneRect.w && y>=phoneRect.y && y<=phoneRect.y+phoneRect.h) return 'phonePos';
        // Resignation
        ctx.font = `${frontResignSize}px ${frontResignFont}`;
        const resignW = ctx.measureText(designState.resignation||'').width; const resignH = frontResignSize;
        const resignRect = {x: designState.resignPos.x - resignW/2, y: designState.resignPos.y - resignH, w: resignW, h: resignH};
        if (x>=resignRect.x && x<=resignRect.x+resignRect.w && y>=resignRect.y && y<=resignRect.y+resignRect.h) return 'resignPos';
        // Company
        ctx.font = `${frontCompanySize}px ${frontCompanyFont}`;
        const compW = ctx.measureText(designState.company||'').width; const compH = frontCompanySize;
        const compRect = {x: designState.companyPos.x - compW/2, y: designState.companyPos.y - compH, w: compW, h: compH};
        if (x>=compRect.x && x<=compRect.x+compRect.w && y>=compRect.y && y<=compRect.y+compRect.h) return 'companyPos';
        // Logo (approx box)
        const logoScale = designState.logoScale || 1; const lw = 120*logoScale; const lh = lw*0.5;
        const lcx = (designState.logoPos?designState.logoPos.x:canvas.width*0.5), lcy=(designState.logoPos?designState.logoPos.y:canvas.height*0.25);
        const lRect = {x: lcx - lw/2, y: lcy - lh/2, w: lw, h: lh};
        if (x>=lRect.x && x<=lRect.x+lRect.w && y>=lRect.y && y<=lRect.y+lRect.h) return 'logoPos';
        // QR (square)
        const qSize = backQrSize; const qRect = {x: designState.qrPos.x - qSize/2, y: designState.qrPos.y - qSize/2, w: qSize, h: qSize};
        if (x>=qRect.x && x<=qRect.x+qRect.w && y>=qRect.y && y<=qRect.y+qRect.h) return 'qrPos';
        return null;
      }
      canvas.addEventListener('mousedown',(ev)=>{ const rect = canvas.getBoundingClientRect(); const x = (ev.clientX-rect.left); const y=(ev.clientY-rect.top); dragging=true; dragTarget = pickTarget(x,y); });
      canvas.addEventListener('mousemove',(ev)=>{ if(!dragging||!dragTarget) return; const rect = canvas.getBoundingClientRect(); const x=(ev.clientX-rect.left); const y=(ev.clientY-rect.top); const pos = designState[dragTarget]||(designState[dragTarget]={x:0,y:0});
        // respect back no-edit right half
        if (designState.side==='back' && dragTarget!=='namePos' && dragTarget!=='phonePos'){ if (x > canvas.width/2) return; }
        pos.x = x; pos.y = y; redrawCardDesign();
      });
      window.addEventListener('mouseup',()=>{ dragging=false; dragTarget=null; });
    })();

    // Inputs bindings
    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id==='frontDesignName'){ designState.name = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontDesignFont'){ designState.font = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontLogoScale'){ designState.logoScale = parseFloat(e.target.value); redrawCardDesign(); }
      if(e.target && e.target.id==='frontResignation'){ designState.resignation = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontCompany'){ designState.company = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontRemoveBg'){ redrawCardDesign(); }
      if(e.target && e.target.id==='frontNameSize'){ frontNameSize = parseInt(e.target.value||'24',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhoneSize'){ frontPhoneSize = parseInt(e.target.value||'18',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhone'){ designBack.phone = e.target.value; designState.phone = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontResignSize'){ frontResignSize = parseInt(e.target.value||'14',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontCompanySize'){ frontCompanySize = parseInt(e.target.value||'16',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontNameFont'){ frontNameFont = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhoneFont'){ frontPhoneFont = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontResignFont'){ frontResignFont = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontCompanyFont'){ frontCompanyFont = e.target.value; redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhoneShow'){ frontPhoneShow = e.target.checked; redrawCardDesign(); }
      if(e.target && e.target.id==='backQrSize'){ backQrSize = parseInt(e.target.value||'90',10); redrawCardDesign(); }
      if(e.target && e.target.id==='backQrMargin'){ backQrMargin = parseInt(e.target.value||'10',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontNameX'){ designState.namePos.x = parseInt(e.target.value||'215',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontNameY'){ designState.namePos.y = parseInt(e.target.value||'165',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontResignX'){ designState.resignPos.x = parseInt(e.target.value||'215',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontResignY'){ designState.resignPos.y = parseInt(e.target.value||'195',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontCompanyX'){ designState.companyPos.x = parseInt(e.target.value||'215',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontCompanyY'){ designState.companyPos.y = parseInt(e.target.value||'140',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhoneX'){ designState.phonePos.x = parseInt(e.target.value||'215',10); redrawCardDesign(); }
      if(e.target && e.target.id==='frontPhoneY'){ designState.phonePos.y = parseInt(e.target.value||'220',10); redrawCardDesign(); }
    });

    // Phone input and QR selection
    (function initPhoneAndQR(){
      const phoneInput = document.getElementById('frontPhone');
      const qrSelect = document.getElementById('backQrType');
      function buildWhatsappLink(raw){
        const digits = (raw||'').replace(/\D/g,'');
        if(!digits) return '';
        return `https://wa.me/+6${digits}`;
      }
      if(phoneInput) phoneInput.addEventListener('input', ()=>{ designBack.phone = phoneInput.value; if(qrSelect && qrSelect.value==='whatsapp'){ const link = buildWhatsappLink(designBack.phone); if(!link){ designBack.qrImg=null; } else { /* regenerate immediately */ const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ designBack.qrImg = img; redrawCardDesign(); }; img.src = `https://quickchart.io/qr?text=${encodeURIComponent(link)}&size=120`; } } else { redrawCardDesign(); } });
      async function loadQR(){
        const type = qrSelect.value; designBack.qrType = type; designBack.qrImg = null; if(type==='none'){ redrawCardDesign(); return; }
        let text = '';
        if(type==='whatsapp'){ text = buildWhatsappLink(designBack.phone); }
        else if(type==='profile'){ if(currentUser){ text = `https://duobuddy.my/${currentUser.username}`; } }
        if(!text){ redrawCardDesign(); return; }
        const img = new Image(); img.crossOrigin = 'anonymous'; img.onload = ()=>{ designBack.qrImg = img; redrawCardDesign(); };
        img.src = `https://quickchart.io/qr?text=${encodeURIComponent(text)}&size=120`;
      }
      if(qrSelect) qrSelect.addEventListener('change', loadQR);
    })();

    (function initDoodle(){
      const up = document.getElementById('frontDoodleUpload');
      const w = document.getElementById('frontDoodleWidth');
      if(up){ up.addEventListener('change', (e)=>{ const file = e.target.files && e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=>{ const img = new Image(); img.onload = ()=>{ designDoodleImg = img; redrawCardDesign(); drawDoodlePreviewCanvas(); const btn = document.getElementById('removeDoodleBtn'); if(btn) btn.style.display = 'inline-block'; }; img.src = r.result; }; r.readAsDataURL(file); }); }
      if(w){ w.addEventListener('input', ()=>{ const v = parseInt(w.value||'16',10); designDoodleWidth = isNaN(v)?16:v; redrawCardDesign(); drawDoodlePreviewCanvas(); }); }
    })();

    function drawDoodlePreviewCanvas(){
      const canvas = document.getElementById('frontDoodlePreviewCanvas'); if(!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#f3f4f6';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      if(designDoodleImg){
        ctx.save();
        ctx.beginPath();
        ctx.rect(0,0,canvas.width,canvas.height);
        ctx.rect(designDoodleWidth, designDoodleWidth, canvas.width - designDoodleWidth*2, canvas.height - designDoodleWidth*2);
        ctx.clip('evenodd');
        ctx.drawImage(designDoodleImg, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      }
    }

    function removeFrontLogo(){
      designState.logo = null;
      const up = document.getElementById('frontDesignLogoUpload'); if (up) up.value = '';
      const btn = document.getElementById('removeLogoBtn'); if (btn) btn.style.display = 'none';
      redrawCardDesign();
    }

    function removeFrontDoodle(){
      designDoodleImg = null;
      const up = document.getElementById('frontDoodleUpload'); if (up) up.value = '';
      const btn = document.getElementById('removeDoodleBtn'); if (btn) btn.style.display = 'none';
      drawDoodlePreviewCanvas(); redrawCardDesign();
    }

    const MY_POSTCODE_RANGES = [
      { from: 1000, to: 2999, region: 'Perlis' },
      { from: 2000, to: 2999, region: 'Kedah' },
      { from: 5000, to: 9810, region: 'Kedah' },
      { from: 10000, to: 14400, region: 'Pulau Pinang' },
      { from: 15000, to: 18500, region: 'Kelantan' },
      { from: 20000, to: 24300, region: 'Terengganu' },
      { from: 25000, to: 28800, region: 'Pahang' },
      { from: 39000, to: 39200, region: 'Pahang' },
      { from: 30000, to: 36810, region: 'Perak' },
      { from: 40000, to: 48300, region: 'Selangor' },
      { from: 63000, to: 68100, region: 'Selangor/KL' },
      { from: 50000, to: 60000, region: 'Kuala Lumpur' },
      { from: 70000, to: 73509, region: 'Negeri Sembilan' },
      { from: 75000, to: 78309, region: 'Melaka' },
      { from: 79000, to: 86900, region: 'Johor' },
      { from: 87000, to: 87033, region: 'Labuan' },
      { from: 88000, to: 91309, region: 'Sabah' },
      { from: 93000, to: 98859, region: 'Sarawak' }
    ];

    function updatePostcodeRegion(){
      const el = document.getElementById('orderPostcode');
      const out = document.getElementById('orderRegion');
      if(!el || !out) return;
      const v = (el.value||'').trim();
      let region = '';
      if(/^[0-9]{5}$/.test(v)){
        const n = parseInt(v,10);
        const r = MY_POSTCODE_RANGES.find(x => n >= x.from && n <= x.to);
        region = r ? r.region : '';
      }
      out.value = region;
    }
    (function initPostcode(){ const el = document.getElementById('orderPostcode'); if(el){ el.addEventListener('input', updatePostcodeRegion); } })();

    function redrawUnifiedDesign(){
      const front = document.getElementById('cardDesignCanvas');
      const back = document.getElementById('cardDesignCanvasBack');
      if (!front || !back) return;
      const design = document.getElementById('orderDesign').value;
      const removeBgFront = !!document.getElementById('frontRemoveBg')?.checked;
      const name = document.getElementById('frontDesignName')?.value || '';
      const font = document.getElementById('frontDesignFont')?.value || 'Arial';
      const scale = parseFloat(document.getElementById('frontLogoScale')?.value || '1');
      const resignation = document.getElementById('frontResignation')?.value || '';
      const company = document.getElementById('frontCompany')?.value || '';
      const phone = document.getElementById('backPhone') ? (document.getElementById('backPhone').value||'') : '';
      designState.name = name; designBack.name = name;
      designState.font = font; designBack.font = font;
      designState.logoScale = scale; designBack.logoScale = scale;
      designState.resignation = resignation; designBack.resignation = resignation;
      designState.company = company; designBack.company = company;
      designState.phone = phone; designBack.phone = phone;
      drawCardSide(front, designState, 'front', design, removeBgFront);
      drawDoodlePreviewCanvas();
      drawCardSide(back, designBack, 'back', design, false);
    }

    function drawCardSide(canvas, state, side, design, removeBg){
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (design === 'Black Matte Card') {
        ctx.fillStyle = '#111827';
        ctx.fillRect(0,0,canvas.width,canvas.height);
      } else if (design === 'Gold Brushed Card') {
        const grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grd.addColorStop(0,'#b58900'); grd.addColorStop(1,'#d9a441');
        ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      } else {
        const grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grd.addColorStop(0,'#9CA3AF'); grd.addColorStop(1,'#D1D5DB');
        ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      const showGrid = (side==='front' ? document.getElementById('frontShowGrid')?.checked : document.getElementById('backShowGrid')?.checked);
      if (showGrid) {
        ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 0.6;
        for (let x = 0; x <= canvas.width; x += 20) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for (let y = 0; y <= canvas.height; y += 20) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
        ctx.restore();
      }

      if (side === 'back') {
        ctx.fillStyle = 'rgba(0,0,0,0.08)';
        ctx.fillRect(canvas.width/2, 0, canvas.width/2, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '12px Arial';
        ctx.fillText('NO EDIT', canvas.width*0.75-30, 20);
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(canvas.width*0.75, canvas.height*0.5, 30, 0, Math.PI*2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(canvas.width*0.75-20, canvas.height*0.5-20);
        ctx.lineTo(canvas.width*0.75+20, canvas.height*0.5+20);
        ctx.stroke();
      }

      if (side === 'front') {
        ctx.fillStyle = design === 'Black Matte Card' ? '#ffffff' : '#111827';
        ctx.font = `${frontNameSize}px ${frontNameFont}`;
        ctx.textAlign = 'center'; ctx.fillText(state.name || '', state.namePos.x, state.namePos.y);
        if (frontPhoneShow) { ctx.font = `${frontPhoneSize}px ${frontPhoneFont}`; ctx.fillText(state.phone || '', state.phonePos.x, state.phonePos.y); }
        ctx.font = `${frontResignSize}px ${frontResignFont}`; ctx.fillText(state.resignation || '', state.resignPos.x, state.resignPos.y);
        ctx.font = `${frontCompanySize}px ${frontCompanyFont}`; ctx.fillText(state.company || '', state.companyPos.x, state.companyPos.y);
      }

      if (side === 'front' && state.logo) {
        const img = state.logo;
        const targetW = 120 * state.logoScale;
        const targetH = (img.height/img.width) * targetW;
        let dx = (state.logoPos ? state.logoPos.x : canvas.width*0.5) - targetW/2;
        let dy = (state.logoPos ? state.logoPos.y : canvas.height*0.25) - targetH/2;
        if (removeBg) {
          const off = document.createElement('canvas'); off.width = img.width; off.height = img.height;
          const octx = off.getContext('2d'); octx.drawImage(img,0,0);
          const imgData = octx.getImageData(0,0,off.width,off.height);
          const d = imgData.data; for (let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; if (r>240 && g>240 && b>240) d[i+3]=0; }
          octx.putImageData(imgData,0,0);
          ctx.drawImage(off, dx, dy, targetW, targetH);
        } else {
          ctx.drawImage(img, dx, dy, targetW, targetH);
        }
      }

      if (side === 'front' && designDoodleImg) {
        ctx.save();
        ctx.drawImage(designDoodleImg, 0, 0, canvas.width, canvas.height);
        ctx.globalCompositeOperation = 'destination-out';
        const innerW = canvas.width - designDoodleWidth*2;
        const innerH = canvas.height - designDoodleWidth*2;
        ctx.fillStyle = '#000';
        ctx.fillRect(designDoodleWidth, designDoodleWidth, innerW, innerH);
        ctx.restore();
      }

      if (side === 'back') {
        const frameLeft = backQrMargin;
        const frameTop = backQrMargin;
        const frameRight = canvas.width/2 - backQrMargin;
        const frameBottom = canvas.height - backQrMargin;
        ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,0.6)';
        ctx.setLineDash([6,4]);
        ctx.strokeRect(frameLeft, frameTop, frameRight-frameLeft, frameBottom-frameTop);
        ctx.restore();
        if (state.qrImg) {
          const size = Math.min(backQrSize, frameRight-frameLeft, frameBottom-frameTop);
          const centerX = (frameLeft + frameRight) / 2;
          const centerY = (frameTop + frameBottom) / 2;
          const dx = centerX - size/2;
          const dy = centerY - size/2;
          ctx.drawImage(state.qrImg, dx, dy, size, size);
        }
      }
    }

    (function initBackDesignDragging(){
      const canvas = document.getElementById('cardDesignCanvasBack'); if(!canvas) return;
      let dragging = false; let dragTarget = null;
      function pickTarget(x,y){
        const ctx = canvas.getContext('2d');
        ctx.font = `${frontNameSize}px ${frontNameFont}`; ctx.textAlign='center';
        const nameW = ctx.measureText(designBack.name||'').width; const nameH = frontNameSize;
        const nameRect = {x: designBack.namePos.x - nameW/2, y: designBack.namePos.y - nameH, w: nameW, h: nameH};
        if (x<=canvas.width/2 && x>=nameRect.x && x<=nameRect.x+nameRect.w && y>=nameRect.y && y<=nameRect.y+nameRect.h) return 'namePos';
        ctx.font = `${frontPhoneSize}px ${frontPhoneFont}`;
        const phoneW = ctx.measureText(designBack.phone||'').width; const phoneH = frontPhoneSize;
        const phoneRect = {x: designBack.phonePos.x - phoneW/2, y: designBack.phonePos.y - phoneH, w: phoneW, h: phoneH};
        if (x<=canvas.width/2 && x>=phoneRect.x && x<=phoneRect.x+phoneRect.w && y>=phoneRect.y && y<=phoneRect.y+phoneRect.h) return 'phonePos';
        const logoScale = designBack.logoScale || 1; const lw = 120*logoScale; const lh = lw*0.5;
        const lcx = (designBack.logoPos?designBack.logoPos.x:canvas.width*0.5), lcy=(designBack.logoPos?designBack.logoPos.y:canvas.height*0.25);
        const lRect = {x: lcx - lw/2, y: lcy - lh/2, w: lw, h: lh};
        if (x<=canvas.width/2 && x>=lRect.x && x<=lRect.x+lRect.w && y>=lRect.y && y<=lRect.y+lRect.h) return 'logoPos';
        const qSize = backQrSize; const qRect = {x: designBack.qrPos.x - qSize/2, y: designBack.qrPos.y - qSize/2, w: qSize, h: qSize};
        if (x<=canvas.width/2 && x>=qRect.x && x<=qRect.x+qRect.w && y>=qRect.y && y<=qRect.y+qRect.h) return 'qrPos';
        return null;
      }
      canvas.addEventListener('mousedown',(ev)=>{ const rect = canvas.getBoundingClientRect(); const x = (ev.clientX-rect.left); const y=(ev.clientY-rect.top); dragging=true; dragTarget = pickTarget(x,y); });
      canvas.addEventListener('mousemove',(ev)=>{ if(!dragging||!dragTarget) return; const rect = canvas.getBoundingClientRect(); const x=(ev.clientX-rect.left); const y=(ev.clientY-rect.top); const pos = designBack[dragTarget]||(designBack[dragTarget]={x:0,y:0}); if (dragTarget!=='namePos' && dragTarget!=='phonePos'){ if (x > canvas.width/2) return; } pos.x = x; pos.y = y; redrawCardDesign(); });
      window.addEventListener('mouseup',()=>{ dragging=false; dragTarget=null; });
    })();
    window.redrawCardDesign = redrawUnifiedDesign;
    redrawCardDesign = redrawUnifiedDesign;
    
    function handlePaymentProofUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        showToast('Image size must be less than 10MB', 'error');
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgEl = document.getElementById('paymentProofPreview');
        imgEl.src = e.target.result;
        imgEl.style.display = 'block';
        document.getElementById('removePaymentProofBtn').style.display = 'inline-block';
        
        showToast('‚úÖ Payment proof uploaded!');
      };
      reader.readAsDataURL(file);
    }
    
    function triggerPaymentProofUpload() {
      const fileInput = document.getElementById('paymentProofUpload');
      if (fileInput) {
        fileInput.click();
      }
    }
    
    function removePaymentProof() {
      const imgEl = document.getElementById('paymentProofPreview');
      imgEl.style.display = 'none';
      imgEl.src = '';
      document.getElementById('removePaymentProofBtn').style.display = 'none';
      document.getElementById('paymentProofUpload').value = '';
      
      showToast('Payment proof removed');
    }
    
    async function handleOrderCard(event) {
      event.preventDefault();
      
      const nameVal = document.getElementById('frontDesignName')?.value || '';
      const phoneVal = document.getElementById('frontPhone')?.value || '';
      if (!nameVal.trim()) { showToast('Please enter your name', 'error'); return; }
      if (!phoneVal.trim()) { showToast('Please enter your phone number', 'error'); return; }
      
      const paymentProofImg = document.getElementById('paymentProofPreview');
      if (paymentProofImg.style.display === 'none' || !paymentProofImg.src) {
        showToast('Please upload payment proof', 'error');
        return;
      }
      
      const slot = currentOrderSlot;
      const design = document.getElementById('orderDesign').value;
      const quantity = parseInt(document.getElementById('orderQuantity').value);
      const address = document.getElementById('orderAddress').value;
      const notes = document.getElementById('orderNotes').value;
      const designImage = document.getElementById('orderDesignImageData').value || '';
      const paymentProof = paymentProofImg.src;
      const postcode = document.getElementById('orderPostcode') ? (document.getElementById('orderPostcode').value||'') : '';
      const region = document.getElementById('orderRegion') ? (document.getElementById('orderRegion').value||'') : '';
      
      try {
        const qrType = document.getElementById('backQrType') ? document.getElementById('backQrType').value : 'none';
        let qrText = '';
        if(qrType==='whatsapp'){ const digits = (document.getElementById('frontPhone')?.value||'').replace(/\D/g,''); if(digits) qrText = `https://wa.me/+6${digits}`; }
        if(qrType==='profile' && currentUser){ qrText = `https://duobuddy.my/${currentUser.username}`; }
        const showPhoneOnCard = !!document.getElementById('frontPhoneShow')?.checked;
        const r = await apiRequest('/api/cards/order', { method: 'POST', body: JSON.stringify({ slot, design, quantity, address, notes, paymentProof, designImage, postcode, region, qrType, qrText, showPhoneOnCard, nameText: nameVal, phoneText: phoneVal }) });
        if (r.ok) {
          const data = await r.json();
          currentUser = data.user;
          showToast(`üì¶ Order placed! Awaiting admin approval.`);
          closeOrderCardModal();
          renderCardSlots();
        } else {
          showToast('Failed to place order', 'error');
        }
      } catch(e) {
        showToast('Failed to place order', 'error');
      }
    }

    function viewCard(slot) {
      if (!currentUser) return;
      
      const profileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      const card = (profileData.cards || []).find(c => c.slot === slot);
      
      if (!card) return;
      
      document.getElementById('viewCardSlot').textContent = slot;
      document.getElementById('viewCardDesign').textContent = card.design || 'N/A';
      document.getElementById('viewCardQuantity').textContent = card.quantity || 1;
      document.getElementById('viewCardStatus').textContent = card.ordered ? 'Active ‚úÖ' : 'Pending ‚è≥';
      
      // Show card design image if available
      const designImg = document.getElementById('viewCardDesignImage');
      const designPlaceholder = document.getElementById('viewCardDesignPlaceholder');
      
      if (card.designImage) {
        designImg.src = card.designImage;
        designImg.style.display = 'block';
        designPlaceholder.style.display = 'none';
      } else {
        designImg.style.display = 'none';
        designPlaceholder.style.display = 'flex';
      }
      
      // Show NFC details if available
      const nfcDetails = document.getElementById('viewCardNfcDetails');
      if (card.nfcSerial || card.nfcPassword) {
        nfcDetails.style.display = 'block';
        document.getElementById('viewNfcSerial').textContent = card.nfcSerial || 'Not assigned';
        document.getElementById('viewNfcPassword').textContent = card.nfcPassword || 'Not assigned';
      } else {
        nfcDetails.style.display = 'none';
      }
      
      document.getElementById('viewCardModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeViewCardModal() {
      document.getElementById('viewCardModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function loadUserProfile(user) {
      const profileData = user.data ? JSON.parse(user.data) : {};
      const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
      
      const avatarEl = document.getElementById('profileAvatar');
      avatarEl.textContent = initials;
      
      if (profileData.profilePicture) {
        avatarEl.style.display = 'none';
        const imgEl = document.createElement('img');
        imgEl.src = profileData.profilePicture;
        imgEl.alt = user.name;
        imgEl.style.cssText = 'width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 24px; object-fit: cover; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);';
        avatarEl.parentElement.insertBefore(imgEl, avatarEl);
      } else {
        avatarEl.style.display = 'flex';
      }
      
      document.getElementById('profileName').textContent = user.name;
      document.getElementById('profileTitle').textContent = profileData.jobTitle || 'Add your job title';
      const pdata = user.data ? JSON.parse(user.data) : {};
      const displayEmail = pdata.useLoginForPreview ? user.email : (pdata.preferredEmail || user.email);
      document.getElementById('profileEmail').textContent = displayEmail;
      document.getElementById('profilePhone').textContent = user.phone;
      document.getElementById('profileCompany').textContent = profileData.company || 'Add your company';
      document.getElementById('profileAbout').textContent = profileData.about || 'Tell people about yourself...';
      document.getElementById('profileURL').textContent = `duobuddy.my/${user.username}`;
      
      renderContactActions('profileContactActions', user.phone, profileData.whatsapp);
      renderSocialLinks('profileSocialLinks', profileData);
    }
    
    function renderContactActions(containerId, phone, whatsapp) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const whatsappNum = whatsapp || phone;
      const cleanPhone = phone.replace(/[^0-9+]/g, '');
      const cleanWhatsapp = whatsappNum.replace(/[^0-9+]/g, '');
      
      container.innerHTML = `
        <a href="tel:${cleanPhone}" class="contact-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
          üìû Call
        </a>
        <a href="sms:${cleanPhone}" class="contact-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
          üí¨ Message
        </a>
        <a href="https://wa.me/${cleanWhatsapp}" target="_blank" rel="noopener noreferrer" class="contact-btn" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white;">
          üì± WhatsApp
        </a>
      `;
    }
    
    function renderSocialLinks(containerId, profileData) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const socials = [];
      
      // Helper function to build URLs from usernames
      function buildSocialUrl(username, platform) {
        if (!username) return null;
        
        // If it already looks like a full URL, use it as-is
        if (username.startsWith('http://') || username.startsWith('https://')) {
          return username;
        }
        
        // Remove @ symbol if present
        const cleanUsername = username.replace(/^@/, '');
        
        switch(platform) {
          case 'facebook':
            return `https://facebook.com/${cleanUsername}`;
          case 'instagram':
            return `https://instagram.com/${cleanUsername}`;
          case 'linkedin':
            return `https://linkedin.com/in/${cleanUsername}`;
          case 'twitter':
            return `https://twitter.com/${cleanUsername}`;
          case 'tiktok':
            return `https://tiktok.com/@${cleanUsername}`;
          case 'youtube':
            return `https://youtube.com/@${cleanUsername}`;
          default:
            return username;
        }
      }
      
      if (profileData.facebook) {
        socials.push({ 
          name: 'Facebook', 
          url: buildSocialUrl(profileData.facebook, 'facebook'), 
          icon: '&#128216;', 
          color: '#1877F2' 
        });
      }
      if (profileData.instagram) {
        socials.push({ 
          name: 'Instagram', 
          url: buildSocialUrl(profileData.instagram, 'instagram'), 
          icon: 'üì∑', 
          color: '#E4405F' 
        });
      }
      if (profileData.linkedin) {
        socials.push({ 
          name: 'LinkedIn', 
          url: buildSocialUrl(profileData.linkedin, 'linkedin'), 
          icon: '&#128188;', 
          color: '#0A66C2' 
        });
      }
      if (profileData.twitter) {
        socials.push({ 
          name: 'Twitter', 
          url: buildSocialUrl(profileData.twitter, 'twitter'), 
          icon: 'üê¶', 
          color: '#1DA1F2' 
        });
      }
      if (profileData.tiktok) {
        socials.push({ 
          name: 'TikTok', 
          url: buildSocialUrl(profileData.tiktok, 'tiktok'), 
          icon: 'üéµ', 
          color: '#000000' 
        });
      }
      if (profileData.youtube) {
        socials.push({ 
          name: 'YouTube', 
          url: buildSocialUrl(profileData.youtube, 'youtube'), 
          icon: '&#128250;', 
          color: '#FF0000' 
        });
      }
      if (profileData.website) {
        const websiteUrl = profileData.website.startsWith('http') ? 
          profileData.website : 
          `https://${profileData.website}`;
        socials.push({ 
          name: 'Website', 
          url: websiteUrl, 
          icon: 'üåê', 
          color: '#667eea' 
        });
      }
      if (profileData.other) {
        const otherUrl = profileData.other.startsWith('http') ? 
          profileData.other : 
          `https://${profileData.other}`;
        socials.push({ 
          name: 'Link', 
          url: otherUrl, 
          icon: 'üîó', 
          color: '#764ba2' 
        });
      }
      
      if (socials.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">üåê Connect With Me</h3>
        <div class="social-links">
          ${socials.map(social => `
            <a href="${social.url}" target="_blank" rel="noopener noreferrer" class="social-btn" style="background: ${social.color}; color: white;">
              <span class="text-2xl">${social.icon}</span>
              <span>${social.name}</span>
            </a>
          `).join('')}
        </div>
      `;
    }

    function handleProfilePictureUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        showToast('Image size must be less than 10MB', 'error');
        event.target.value = '';
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        showImageCropModal(e.target.result);
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }
    
    let cropImage = null;
    let cropCanvas = null;
    let cropCtx = null;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let offsetX = 0;
    let offsetY = 0;
    let scale = 1;
    
    function showImageCropModal(imageSrc) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.zIndex = '99999';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
          <div class="p-8">
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">‚úÇÔ∏è Crop Profile Picture</h3>
            <div style="position: relative; width: 400px; height: 400px; margin: 0 auto 20px; background: #f3f4f6; border-radius: 16px; overflow: hidden;">
              <canvas id="cropCanvas" width="400" height="400" style="display: block; cursor: move;"></canvas>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; border: 3px solid #667eea; border-radius: 50%; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);"></div>
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 mb-2 font-semibold text-center">Zoom</label>
              <input type="range" id="cropZoom" min="0.5" max="3" step="0.1" value="1" class="w-full" style="width: 100%;">
            </div>
            <div class="flex gap-4 justify-center">
              <button class="btn btn-primary" onclick="applyCrop()">‚úÖ Apply Crop</button>
              <button class="btn btn-secondary" onclick="cancelCrop()">‚ùå Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      cropCanvas = document.getElementById('cropCanvas');
      cropCtx = cropCanvas.getContext('2d');
      cropImage = new Image();
      cropImage.onload = function() {
        scale = 1;
        offsetX = 0;
        offsetY = 0;
        drawCropPreview();
      };
      cropImage.src = imageSrc;
      
      cropCanvas.addEventListener('mousedown', startDrag);
      cropCanvas.addEventListener('mousemove', drag);
      cropCanvas.addEventListener('mouseup', endDrag);
      cropCanvas.addEventListener('mouseleave', endDrag);
      
      cropCanvas.addEventListener('touchstart', handleTouchStart);
      cropCanvas.addEventListener('touchmove', handleTouchMove);
      cropCanvas.addEventListener('touchend', endDrag);
      
      document.getElementById('cropZoom').addEventListener('input', function(e) {
        scale = parseFloat(e.target.value);
        drawCropPreview();
      });
    }
    
    function startDrag(e) {
      isDragging = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
    }
    
    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      offsetX = e.clientX - startX;
      offsetY = e.clientY - startY;
      drawCropPreview();
    }
    
    function endDrag() {
      isDragging = false;
    }
    
    function handleTouchStart(e) {
      isDragging = true;
      const touch = e.touches[0];
      startX = touch.clientX - offsetX;
      startY = touch.clientY - offsetY;
    }
    
    function handleTouchMove(e) {
      if (!isDragging) return;
      e.preventDefault();
      const touch = e.touches[0];
      offsetX = touch.clientX - startX;
      offsetY = touch.clientY - offsetY;
      drawCropPreview();
    }
    
    function drawCropPreview() {
      if (!cropImage || !cropCtx) return;
      
      cropCtx.clearRect(0, 0, 400, 400);
      cropCtx.fillStyle = '#f3f4f6';
      cropCtx.fillRect(0, 0, 400, 400);
      
      const imgWidth = cropImage.width * scale;
      const imgHeight = cropImage.height * scale;
      
      const x = 200 - imgWidth / 2 + offsetX;
      const y = 200 - imgHeight / 2 + offsetY;
      
      cropCtx.drawImage(cropImage, x, y, imgWidth, imgHeight);
    }
    
    function applyCrop() {
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = 300;
      finalCanvas.height = 300;
      const finalCtx = finalCanvas.getContext('2d');
      
      finalCtx.beginPath();
      finalCtx.arc(150, 150, 150, 0, Math.PI * 2);
      finalCtx.closePath();
      finalCtx.clip();
      
      const imgWidth = cropImage.width * scale;
      const imgHeight = cropImage.height * scale;
      
      const sourceX = 200 - imgWidth / 2 + offsetX;
      const sourceY = 200 - imgHeight / 2 + offsetY;
      
      const cropX = (50 - sourceX) / scale;
      const cropY = (50 - sourceY) / scale;
      const cropSize = 300 / scale;
      
      finalCtx.drawImage(
        cropImage,
        cropX, cropY, cropSize, cropSize,
        0, 0, 300, 300
      );
      
      const croppedDataUrl = finalCanvas.toDataURL('image/jpeg', 0.9);
      
      const avatarEl = document.getElementById('editProfileAvatar');
      const imgEl = document.getElementById('editProfileImage');
      
      avatarEl.style.display = 'none';
      imgEl.src = croppedDataUrl;
      imgEl.style.display = 'block';
      document.getElementById('removeProfilePicBtn').style.display = 'inline-block';
      
      cancelCrop();
      showToast('‚úÖ Profile picture cropped!');
    }
    
    function cancelCrop() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        modal.remove();
      }
      document.body.style.overflow = 'auto';
      cropImage = null;
      cropCanvas = null;
      cropCtx = null;
    }

    function removeProfilePicture() {
      const avatarEl = document.getElementById('editProfileAvatar');
      const imgEl = document.getElementById('editProfileImage');
      
      imgEl.style.display = 'none';
      imgEl.src = '';
      avatarEl.style.display = 'flex';
      document.getElementById('removeProfilePicBtn').style.display = 'none';
      document.getElementById('profilePictureUpload').value = '';
      
      showToast('Profile picture removed');
    }

    function loadEditProfileForm() {
      if (!currentUser) return;
      
      const profileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
      
      const avatarEl = document.getElementById('editProfileAvatar');
      const imgEl = document.getElementById('editProfileImage');
      
      avatarEl.textContent = initials;
      
      if (profileData.profilePicture) {
        avatarEl.style.display = 'none';
        imgEl.src = profileData.profilePicture;
        imgEl.style.display = 'block';
        document.getElementById('removeProfilePicBtn').style.display = 'inline-block';
      } else {
        avatarEl.style.display = 'flex';
        imgEl.style.display = 'none';
        document.getElementById('removeProfilePicBtn').style.display = 'none';
      }
      
      document.getElementById('editName').value = currentUser.name;
      document.getElementById('editUsername').value = currentUser.username;
      document.getElementById('editJobTitle').value = profileData.jobTitle || '';
      document.getElementById('editCompany').value = profileData.company || '';
      document.getElementById('editPhone').value = currentUser.phone;
      document.getElementById('editWhatsapp').value = profileData.whatsapp || '';
      const loginEmailEl = document.getElementById('editLoginEmail');
      const preferredEmailEl = document.getElementById('editPreferredEmail');
      const useLoginForPreviewEl = document.getElementById('editUseLoginForPreview');
      if (loginEmailEl) loginEmailEl.value = currentUser.email;
      if (preferredEmailEl) preferredEmailEl.value = profileData.preferredEmail || '';
      if (useLoginForPreviewEl) useLoginForPreviewEl.checked = !!profileData.useLoginForPreview;
      document.getElementById('editAbout').value = profileData.about || '';
      
      document.getElementById('editFacebook').value = profileData.facebook || '';
      document.getElementById('editInstagram').value = profileData.instagram || '';
      document.getElementById('editLinkedin').value = profileData.linkedin || '';
      document.getElementById('editTwitter').value = profileData.twitter || '';
      document.getElementById('editTiktok').value = profileData.tiktok || '';
      document.getElementById('editYoutube').value = profileData.youtube || '';
      document.getElementById('editWebsite').value = profileData.website || '';
      document.getElementById('editOther').value = profileData.other || '';
      
      document.getElementById('editUrlPreview').textContent = `duobuddy.my/${currentUser.username}`;
      validateUsername(currentUser.username, 'edit');
    }

    async function handleUpdateProfile(event) {
      event.preventDefault();
      
      const newUsername = document.getElementById('editUsername').value;
      
      if (isReservedUsername(newUsername)) {
        showToast('Username is reserved', 'error');
        return;
      }
      
      const similar = findSimilarUsernames(newUsername);
      const isCurrent = normalizeUsername(currentUser.username) === normalizeUsername(newUsername);
      
      if (similar.length && !isCurrent) {
        showToast('Username already taken', 'error');
        return;
      }
      
      document.getElementById('updateBtnText').style.display = 'none';
      document.getElementById('updateBtnLoading').style.display = 'inline';
      document.getElementById('updateBtn').disabled = true;
      
      const oldProfileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      
      const imgEl = document.getElementById('editProfileImage');
      const profilePicture = (imgEl.style.display !== 'none' && imgEl.src && imgEl.src !== '') ? imgEl.src : null;
      
      const jt = document.getElementById('editJobTitle').value;
      if (isSubAdmin) {
        const banned = /(admin|administrator|ceo|chief)/i;
        if (banned.test(jt)) { showToast('Job title contains restricted terms', 'error'); document.getElementById('updateBtnText').style.display = 'inline'; document.getElementById('updateBtnLoading').style.display = 'none'; document.getElementById('updateBtn').disabled = false; return; }
      }
      const profileData = {
        jobTitle: jt,
        company: document.getElementById('editCompany').value,
        about: document.getElementById('editAbout').value,
        whatsapp: document.getElementById('editWhatsapp').value,
        facebook: document.getElementById('editFacebook').value,
        instagram: document.getElementById('editInstagram').value,
        linkedin: document.getElementById('editLinkedin').value,
        twitter: document.getElementById('editTwitter').value,
        tiktok: document.getElementById('editTiktok').value,
        youtube: document.getElementById('editYoutube').value,
        website: document.getElementById('editWebsite').value,
        other: document.getElementById('editOther').value,
        profilePicture: profilePicture,
        created: oldProfileData.created || new Date().toISOString(),
        trialEnd: oldProfileData.trialEnd,
        paymentApproved: oldProfileData.paymentApproved,
        approvedDate: oldProfileData.approvedDate,
        cards: oldProfileData.cards || [],
        preferredEmail: document.getElementById('editPreferredEmail') ? document.getElementById('editPreferredEmail').value : (oldProfileData.preferredEmail || ''),
        useLoginForPreview: document.getElementById('editUseLoginForPreview') ? document.getElementById('editUseLoginForPreview').checked : (!!oldProfileData.useLoginForPreview)
      };
      
      const updated = {
        ...currentUser,
        name: document.getElementById('editName').value,
        username: newUsername,
        phone: document.getElementById('editPhone').value,
        data: JSON.stringify(profileData)
      };
      
      const result = await window.dataSdk.update(updated);
      
      document.getElementById('updateBtnText').style.display = 'inline';
      document.getElementById('updateBtnLoading').style.display = 'none';
      document.getElementById('updateBtn').disabled = false;
      
      if (result.isOk) {
        currentUser = updated;
        loadUserProfile(updated);
        showToast('‚úÖ Profile updated successfully!');
        await logActivity('profile_edit', updated.__backendId, updated.name, `Profile updated for ${updated.email}`);
        setTimeout(() => showPage('profile'), 1000);
      } else {
        showToast('Failed to update profile', 'error');
      }
    }

    async function handleChangePassword(event) {
      event.preventDefault();
      
      if (!currentUser) return;
      
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      if (newPass !== confirm) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      if (!isStrongPassword(newPass)) { showToast('Password too weak: 7+ chars, include special symbol, avoid common patterns', 'error'); return; }
      
      document.getElementById('changePasswordBtnText').style.display = 'none';
      document.getElementById('changePasswordBtnLoading').style.display = 'inline';
      document.getElementById('changePasswordBtn').disabled = true;
      
      try {
        const r = await apiRequest('/api/auth/change_password', { method: 'POST', body: JSON.stringify({ currentPassword: current, newPassword: newPass }) });
        document.getElementById('changePasswordBtnText').style.display = 'inline';
        document.getElementById('changePasswordBtnLoading').style.display = 'none';
        document.getElementById('changePasswordBtn').disabled = false;
        if (r.ok) {
          showToast('Password changed successfully!');
          await logActivity('password_change', currentUser?.__backendId, currentUser?.name || 'User', `Password changed for ${currentUser?.email || ''}`);
          document.getElementById('changePasswordForm').reset();
          setTimeout(() => showPage(isAdmin ? 'admin' : 'my-cards'), 1000);
        } else {
          showToast('Failed to change password', 'error');
        }
      } catch(e) {
        document.getElementById('changePasswordBtnText').style.display = 'inline';
        document.getElementById('changePasswordBtnLoading').style.display = 'none';
        document.getElementById('changePasswordBtn').disabled = false;
        showToast('Failed to change password', 'error');
      }
      
    }

    function getUserStatus(user) {
      if (user.deleted) return 'deleted';
      
      const profileData = user.data ? JSON.parse(user.data) : {};
      const trialEnd = profileData.trialEnd ? new Date(profileData.trialEnd) : null;
      const now = new Date();
      
      if (profileData.paymentApproved) return 'approved';
      if (trialEnd && now >= trialEnd) return 'expired';
      if (trialEnd && now < trialEnd) return 'trial';
      return 'pending';
    }

    function getStatusBadge(status) {
      const badges = {
        trial: '<span class="status-badge status-trial">Trial</span>',
        pending: '<span class="status-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">Pending</span>',
        approved: '<span class="status-badge status-active">Approved</span>',
        expired: '<span class="status-badge status-expired">Expired</span>',
        deleted: '<span class="status-badge" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">Deleted</span>'
      };
      return badges[status] || '';
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('active');
      filterUsers();
    }

    function filterUsers() {
      const searchTerm = document.getElementById('adminSearchInput')?.value.toLowerCase() || '';
      currentSearch = searchTerm;
      
      const users = allUsers.filter(u => !u.is_admin);
      
      let filteredUsers = users.filter(user => {
        const matchesSearch = 
          user.name.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm) ||
          user.username.toLowerCase().includes(searchTerm);
        
        if (!matchesSearch) return false;
        
        const status = getUserStatus(user);
        if (currentFilter === 'all') return true;
        return status === currentFilter;
      });
      if (currentFilter === 'subadmin') {
        filteredUsers = filteredUsers.filter(u => !!u.is_subadmin);
      }
      
      const tbody = document.getElementById('adminUserTable');
      
      if (!filteredUsers.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-10 text-lg">No users found matching your criteria</td></tr>';
      } else {
        tbody.innerHTML = filteredUsers.map(u => {
          const status = getUserStatus(u);
          const isDeleted = u.deleted;
          return `
            <tr style="${isDeleted ? 'opacity: 0.5;' : ''}">
              <td class="font-semibold">${u.name}</td>
              <td>${u.email}</td>
              <td><span class="text-purple-600 font-semibold">${u.username}</span></td>
              <td>${getStatusBadge(status)}</td>
              <td>${u.data ? new Date(JSON.parse(u.data).created).toLocaleDateString() : 'N/A'}</td>
              <td>
                <button class="btn btn-primary" onclick="openAdminUserModal('${u.__backendId}')" style="padding: 8px 16px; font-size: 14px;">${isDeleted ? 'üëÅÔ∏è View' : '‚öôÔ∏è Manage'}</button>
                ${isDeleted ? `<button class='btn btn-secondary ml-2' onclick="handleRestoreUser('${u.__backendId}')">‚ôªÔ∏è Restore</button>` : ''}
              </td>
            </tr>
          `;
        }).join('');
      }
    }

    function updateAdminDashboard() {
      const users = allUsers.filter(u => !u.is_admin);
      
      const statusCounts = {
        all: users.length,
        trial: users.filter(u => getUserStatus(u) === 'trial').length,
        pending: users.filter(u => getUserStatus(u) === 'pending').length,
        approved: users.filter(u => getUserStatus(u) === 'approved').length,
        expired: users.filter(u => getUserStatus(u) === 'expired').length,
        deleted: users.filter(u => u.deleted).length
      };
      
      document.getElementById('adminTotalUsers').textContent = statusCounts.all;
      document.getElementById('adminTrialUsers').textContent = statusCounts.trial;
      document.getElementById('adminApprovedUsers').textContent = statusCounts.approved;
      document.getElementById('adminPendingUsers').textContent = statusCounts.pending;
      
      document.getElementById('countAll').textContent = statusCounts.all;
      document.getElementById('countTrial').textContent = statusCounts.trial;
      document.getElementById('countPending').textContent = statusCounts.pending;
      document.getElementById('countApproved').textContent = statusCounts.approved;
      document.getElementById('countExpired').textContent = statusCounts.expired;
      document.getElementById('countDeleted').textContent = statusCounts.deleted;
    }

    function getCompanyUsers(name){
      return allUsers.filter(function(u){
        if (u.is_admin) return false;
        const pd = u.data ? JSON.parse(u.data) : {};
        return (pd.company || '').trim() === name.trim();
      });
    }

    function openCreateCompanyModal(){
      if (!isAdmin) { showToast('Only admin can create companies', 'error'); return; }
      const m = document.getElementById('createCompanyModal'); if (m) m.style.display = 'block'; document.body.style.overflow = 'hidden';
    }
    function closeCreateCompanyModal(){
      const m = document.getElementById('createCompanyModal'); if (m) m.style.display = 'none'; document.body.style.overflow = '';
      const f = document.getElementById('createCompanyForm'); if (f) f.reset();
    }
    async function handleCreateCompany(e){
      e.preventDefault();
      const name = document.getElementById('companyName').value.trim();
      if (!name) { showToast('Enter company name','error'); return; }
      const obj = {
        type: 'company_record',
        name,
        color: document.getElementById('companyColor').value.trim(),
        domain: document.getElementById('companyDomain').value.trim().toLowerCase(),
        logo: document.getElementById('companyLogo').value.trim(),
        billingName: document.getElementById('companyBillingName').value.trim(),
        billingEmail: document.getElementById('companyBillingEmail').value.trim(),
        billingPhone: document.getElementById('companyBillingPhone').value.trim(),
        address: document.getElementById('companyAddress').value.trim(),
        notes: document.getElementById('companyNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      const r = await window.dataSdk.create(obj);
      if (r && r.isOk) { showToast('‚úÖ Company created'); closeCreateCompanyModal(); renderCompanyList(); } else { showToast('Failed to create company','error'); }
    }
    function getCompanyRecord(name){
      return (companies || []).find(function(c){ return (c.name||'').trim() === name.trim(); });
    }
    function openEditCompanyModal(name){
      if (!isAdmin) { showToast('Only admin can edit companies', 'error'); return; }
      const rec = getCompanyRecord(name);
      if (!rec) { showToast('Company not found', 'error'); return; }
      const title = document.getElementById('editCompanyTitle'); if (title) title.textContent = name;
      const setVal = function(id, val){ const el = document.getElementById(id); if (el) el.value = val || ''; };
      setVal('editCompanyDomain', rec.domain || '');
      setVal('editCompanyColor', rec.color || '');
      setVal('editCompanyLogo', rec.logo || '');
      setVal('editCompanyBillingName', rec.billingName || '');
      setVal('editCompanyBillingEmail', rec.billingEmail || '');
      setVal('editCompanyBillingPhone', rec.billingPhone || '');
      setVal('editCompanyAddress', rec.address || '');
      setVal('editCompanyNotes', rec.notes || '');
      const m = document.getElementById('editCompanyModal'); if (m) m.style.display = 'block'; document.body.style.overflow = 'hidden';
    }
    function closeEditCompanyModal(){
      const m = document.getElementById('editCompanyModal'); if (m) m.style.display = 'none'; document.body.style.overflow = '';
      const f = document.getElementById('editCompanyForm'); if (f) f.reset();
    }
    async function handleUpdateCompany(e){
      e.preventDefault();
      const name = document.getElementById('editCompanyTitle').textContent;
      const rec = getCompanyRecord(name);
      if (!rec) { showToast('Company not found', 'error'); return; }
      const updated = {
        ...rec,
        type: 'company_record',
        name,
        domain: document.getElementById('editCompanyDomain').value.trim().toLowerCase(),
        color: document.getElementById('editCompanyColor').value.trim(),
        logo: document.getElementById('editCompanyLogo').value.trim(),
        billingName: document.getElementById('editCompanyBillingName').value.trim(),
        billingEmail: document.getElementById('editCompanyBillingEmail').value.trim(),
        billingPhone: document.getElementById('editCompanyBillingPhone').value.trim(),
        address: document.getElementById('editCompanyAddress').value.trim(),
        notes: document.getElementById('editCompanyNotes').value.trim()
      };
      const r = await window.dataSdk.update(updated);
      if (r && r.isOk) { showToast('‚úÖ Company updated'); closeEditCompanyModal(); renderCompanyList(); renderCompanyDetail(name); }
      else { showToast('Failed to update company','error'); }
    }
    function deleteCompanyRecord(name){
      if (!confirm('Delete company and unassign employees?')) return;
      try{
        const key='__duobuddy_store__';
        const arr=JSON.parse(localStorage.getItem(key)||'[]');
        const filtered=arr.filter(function(x){ return !(x.type==='company_record' && (x.name||'').trim()===name.trim()); });
        const users=filtered.map(function(u){
          if (u.type && u.type !== 'user') return u;
          const pd=u.data?JSON.parse(u.data):{}; if((pd.company||'').trim()===name.trim()){ pd.company=''; u.data=JSON.stringify(pd); }
          return u;
        });
        localStorage.setItem(key, JSON.stringify(users));
        if (dataHandler && dataHandler.onDataChanged) dataHandler.onDataChanged(users);
        showToast('üóëÔ∏è Company deleted'); renderCompanyList();
      }catch(e){ showToast('Failed to delete company','error'); }
    }
    function openAssignEmployeesModal(name){
      const users = allUsers.filter(function(u){
        if (u.is_admin) return false;
        const pd = u.data ? JSON.parse(u.data) : {};
        return (pd.company || '').trim() !== name.trim();
      });
      const container = document.getElementById('assignEmployeesList');
      const title = document.getElementById('assignEmployeesTitle');
      if (title) title.textContent = name;
      if (container) {
        if (!users.length) { container.innerHTML = '<div class="text-gray-500">No available users</div>'; }
        else {
          container.innerHTML = users.map(function(u){
            return '<div class="flex justify-between items-center p-3 border rounded-lg mb-2"><div><div class="font-semibold">'+u.name+'</div><div class="text-gray-600 text-sm">'+u.email+'</div></div><button class="btn btn-primary" onclick="assignUserToCompany(\''+name.replace(/'/g,"\\'")+'\', \''+u.__backendId+'\')">Add</button></div>';
          }).join('');
        }
      }
      const m = document.getElementById('assignEmployeesModal'); if (m) m.style.display='block'; document.body.style.overflow='hidden';
    }
    function closeAssignEmployeesModal(){ const m=document.getElementById('assignEmployeesModal'); if(m) m.style.display='none'; document.body.style.overflow=''; }
    async function assignUserToCompany(name, userId){
      const u = allUsers.find(function(x){ return x.__backendId===userId; });
      if(!u) return;
      const pd = u.data ? JSON.parse(u.data) : {};
      pd.company = name;
      const updated = { ...u, data: JSON.stringify(pd) };
      const r = await window.dataSdk.update(updated);
      if(r && r.isOk){ showToast('‚úÖ Assigned'); openAssignEmployeesModal(name); renderCompanyDetail(name); renderCompanyList(); } else { showToast('Failed to assign','error'); }
    }
    function exportCompanyEmployees(name){
      const users = getCompanyUsers(name);
      if(!users.length){ showToast('No employees to export','error'); return; }
      const headers = ['Name','Email','Username','Phone','Status','Job Title','Joined Date'];
      const rows = users.map(function(u){
        const pd = u.data ? JSON.parse(u.data) : {};
        const st = getUserStatus(u);
        return [u.name,u.email,u.username,u.phone,st,pd.jobTitle||'',pd.created?new Date(pd.created).toLocaleDateString():''].map(function(f){ return '"'+String(f).replace(/"/g,'""')+'"'; }).join(',');
      });
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=name.replace(/\s+/g,'_')+'_employees.csv'; a.click(); window.URL.revokeObjectURL(url);
      showToast('üì• Exported employees');
    }
    function autoAssignByDomain(name){
      const rec = getCompanyRecord(name); if(!rec || !rec.domain){ showToast('Set company domain first','error'); return; }
      const domain = rec.domain.toLowerCase();
      const candidates = allUsers.filter(function(u){
        if (u.is_admin) return false;
        const pd = u.data ? JSON.parse(u.data) : {};
        const email = (u.email || '').toLowerCase();
        const inCompany = (pd.company || '').trim() === name.trim();
        return !inCompany && email.endsWith('@'+domain);
      });
      candidates.forEach(function(u){
        const pd = u.data ? JSON.parse(u.data) : {}; pd.company = name; window.dataSdk.update({ ...u, data: JSON.stringify(pd) });
      });
      showToast('‚úÖ Auto-assigned employees'); renderCompanyDetail(name); renderCompanyList();
    }
    function renderCompanyList(){
      const container = document.getElementById('companyList'); if (!container) return;
      const map = {};
      allUsers.forEach(function(u){
        if (u.is_admin) return;
        const pd = u.data ? JSON.parse(u.data) : {};
        const name = (pd.company || '').trim();
        if (!name) return;
        if (!map[name]) map[name] = [];
        map[name].push(u);
      });
      (companies || []).forEach(function(c){
        const name = (c.name || '').trim();
        if (!name) return;
        if (!map[name]) map[name] = [];
      });
      let list = Object.keys(map).sort();
      const q = (document.getElementById('companySearchInput')?.value || '').trim().toLowerCase();
      if (q) list = list.filter(function(n){ return n.toLowerCase().includes(q); });
      if (list.length === 0) { container.innerHTML = '<div class="text-gray-500">No companies found</div>'; return; }
      container.innerHTML = list.map(function(name){
        const users = map[name];
        const count = users.length;
        const approved = users.filter(function(u){ return getUserStatus(u)==='approved'; }).length;
        const rec = getCompanyRecord(name);
        const domain = rec && rec.domain ? rec.domain : '';
        return (
          '<div class="card p-6">'
          + '<div class="flex justify-between items-center">'
          + '<div>'
          + '<h3 class="text-xl font-bold text-gray-800">' + name + '</h3>'
          + '<p class="text-gray-600">Employees: ' + count + ' ‚Ä¢ Approved: ' + approved + (domain ? ' ‚Ä¢ Domain: '+domain : '') + '</p>'
          + '</div>'
          + '<div class="flex gap-3">'
          + '<button class="btn btn-primary" onclick="showCompanyDetail(\'' + name.replace(/'/g,"\\'") + '\')">Manage</button>'
          + '<button class="btn btn-secondary" onclick="openEditCompanyModal(\'' + name.replace(/'/g,"\\'") + '\')">üõ†Ô∏è Edit</button>'
          + '<button class="btn btn-secondary" onclick="openAssignEmployeesModal(\'' + name.replace(/'/g,"\\'") + '\')">Assign</button>'
          + '<button class="btn btn-secondary" onclick="exportCompanyEmployees(\'' + name.replace(/'/g,"\\'") + '\')">Export</button>'
          + '<button class="btn btn-danger" onclick="deleteCompanyRecord(\'' + name.replace(/'/g,"\\'") + '\')">Delete</button>'
          + '</div>'
          + '</div>'
          + '</div>'
        );
      }).join('');
    }
    function updateCompanyManagement(){
      try{
        const totalCompanies = (companies || []).length;
        const nonAdmins = allUsers.filter(function(u){ return !u.is_admin; });
        const assigned = nonAdmins.filter(function(u){ const pd=u.data?JSON.parse(u.data):{}; return !!(pd.company||'').trim(); });
        const approvedAssigned = assigned.filter(function(u){ return getUserStatus(u)==='approved'; });
        const pendingExpiredAssigned = assigned.filter(function(u){ const st=getUserStatus(u); return st==='pending' || st==='expired'; });
        const setText = function(id,val){ const el=document.getElementById(id); if(el) el.textContent = String(val); };
        setText('companyTotalCount', totalCompanies);
        setText('companyTotalEmployees', assigned.length);
        setText('companyApprovedEmployees', approvedAssigned.length);
        setText('companyPendingExpired', pendingExpiredAssigned.length);
        renderMissingDomains();
      }catch(e){}
    }
    function renderMissingDomains(){
      const container = document.getElementById('missingDomainsList'); if(!container) return;
      const missing = (companies || []).filter(function(c){ return !(c.domain||'').trim(); });
      if (!missing.length) { container.innerHTML = '<div class=\"text-gray-500\">All companies have domains set</div>'; return; }
      container.innerHTML = missing.map(function(c){
        const name = c.name || '';
        return (
          '<div class=\"card p-5\">'
          + '<div class=\"flex justify-between items-center\">'
          + '<div><div class=\"font-bold text-gray-800\">' + name + '</div><div class=\"text-gray-600\">No domain configured</div></div>'
          + '<div class=\"flex gap-3\"><button class=\"btn btn-secondary\" onclick=\"openEditCompanyModal(\'' + name.replace(/'/g,"\\'") + '\')\">üõ†Ô∏è Edit</button>'
          + '</div>'
          + '</div>'
          + '</div>'
        );
      }).join('');
    }
    function exportCompaniesToCSV(){
      const list = (companies || []);
      if (!list.length) { showToast('No companies to export','error'); return; }
      const headers = ['Name','Domain','Color','Logo','Billing Name','Billing Email','Billing Phone','Address','Notes','Created At'];
      const rows = list.map(function(c){
        return [c.name,c.domain,c.color,c.logo,c.billingName,c.billingEmail,c.billingPhone,c.address,c.notes,c.createdAt]
          .map(function(f){ return '\"' + String(f||'').replace(/\"/g,'\"\"') + '\"'; }).join(',');
      });
      const csv = [headers.join(','), ...rows].join('\\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='companies_export.csv'; a.click(); window.URL.revokeObjectURL(url);
      showToast('üì• Exported companies');
    }
    function autoAssignAllByDomain(){
      const cs = (companies || []).filter(function(c){ return !!(c.domain||'').trim(); });
      if (!cs.length) { showToast('No company domains configured','error'); return; }
      cs.forEach(function(c){ try{ autoAssignByDomain(c.name); }catch(e){} });
    }

    function showCompanyDetail(name){ renderCompanyDetail(name); showPage('company-detail'); }

    function openCompanyTab(name){
      const url = window.location.origin + window.location.pathname + '#company=' + encodeURIComponent(name);
      window.open(url, '_blank');
    }

    function renderCompanyDetail(name){
      const title = document.getElementById('companyDetailTitle'); if (title) title.textContent = 'üè¢ ' + name;
      const tbody = document.getElementById('companyEmployeesTable'); if (!tbody) return;
      populateCompanySettings(name);
      const users = getCompanyUsers(name);
      if (!users.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-10">No employees found</td></tr>'; return; }
      tbody.innerHTML = users.map(function(u){
        const status = getUserStatus(u);
        return (
          '<tr>'
          + '<td class="font-semibold">' + u.name + '</td>'
          + '<td>' + u.email + '</td>'
          + '<td><span class="text-purple-600 font-semibold">' + u.username + '</span></td>'
          + '<td>' + getStatusBadge(status) + '</td>'
          + '<td><button class="btn btn-primary" onclick="openAdminUserModal(\'' + u.__backendId + '\')">‚öôÔ∏è Manage User</button></td>'
          + '</tr>'
        );
      }).join('');
    }
    function populateCompanySettings(name){
      const rec = getCompanyRecord(name) || {};
      const setVal = function(id, val){ const el = document.getElementById(id); if (el) el.value = val || ''; };
      setVal('companySettingsDomain', rec.domain || '');
      setVal('companySettingsLogo', rec.logo || '');
      setVal('companySettingsColor', rec.color || '');
      setVal('companySettingsBillingName', rec.billingName || '');
      setVal('companySettingsBillingEmail', rec.billingEmail || '');
      setVal('companySettingsBillingPhone', rec.billingPhone || '');
      setVal('companySettingsAddress', rec.address || '');
      setVal('companySettingsNotes', rec.notes || '');
    }
    async function handleSaveCompanySettings(name){
      if (!isAdmin) { showToast('Only admin can update companies', 'error'); return; }
      const rec = getCompanyRecord(name);
      if (!rec) { showToast('Company not found', 'error'); return; }
      const updated = {
        ...rec,
        type: 'company_record',
        name,
        domain: document.getElementById('companySettingsDomain').value.trim().toLowerCase(),
        logo: document.getElementById('companySettingsLogo').value.trim(),
        color: document.getElementById('companySettingsColor').value.trim(),
        billingName: document.getElementById('companySettingsBillingName').value.trim(),
        billingEmail: document.getElementById('companySettingsBillingEmail').value.trim(),
        billingPhone: document.getElementById('companySettingsBillingPhone').value.trim(),
        address: document.getElementById('companySettingsAddress').value.trim(),
        notes: document.getElementById('companySettingsNotes').value.trim()
      };
      const r = await window.dataSdk.update(updated);
      if (r && r.isOk) { showToast('‚úÖ Company settings saved'); renderCompanyList(); renderCompanyDetail(name); }
      else { showToast('Failed to save settings','error'); }
    }

    function openSubAdminModal(){
      if (!isAdmin) { showToast('Only admin can register sub-admin', 'error'); return; }
      const m = document.getElementById('subAdminModal'); if (m) m.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeSubAdminModal(){
      const m = document.getElementById('subAdminModal'); if (m) m.style.display = 'none';
      document.body.style.overflow = '';
    }
    async function handleRegisterSubAdmin(event){
      event.preventDefault();
      const name = document.getElementById('subAdminName').value.trim();
      const username = document.getElementById('subAdminUsername').value.trim();
      const email = document.getElementById('subAdminEmail').value.trim();
      const phone = document.getElementById('subAdminPhone').value.trim();
      const password = document.getElementById('subAdminPassword').value;
      if (!name || !username || !email || !password) { showToast('Please fill all required fields', 'error'); return; }
      const r = await apiRequest('/api/admin/register_subadmin', { method: 'POST', body: JSON.stringify({ name, username, email, phone, password }) });
      if (r.ok) { showToast('‚úÖ Sub-admin created'); closeSubAdminModal(); await refreshAdminUsers(); } else { showToast(r.error || 'Failed to create sub-admin', 'error'); }
    }

    function updateActivityLogs() {
      const tbody = document.getElementById('activityLogsTable');
      
      if (!activityLogs.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-10">No activity logs yet</td></tr>';
        return;
      }
      
      const recentLogs = activityLogs.slice(0, 50);
      
      tbody.innerHTML = recentLogs.map(log => {
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleString();
        
        const activityIcons = {
          login: 'üîê',
          signup: '‚ú®',
          profile_edit: '‚úèÔ∏è',
          password_change: 'üîë',
          payment_submit: 'üí≥',
          payment_approve: '‚úÖ',
          admin_reset_password: 'üîß',
          admin_delete_user: 'üóëÔ∏è'
        };
        
        const icon = activityIcons[log.activity_type] || '&#128221;';
        
        return `
          <tr>
            <td class="text-sm">${formattedDate}</td>
            <td class="font-semibold">${log.name}</td>
            <td><span class="text-2xl">${icon}</span> ${log.activity_type.replace(/_/g, ' ').toUpperCase()}</td>
            <td class="text-gray-600">${log.details}</td>
          </tr>
        `;
      }).join('');
    }
    
    function repositionActivityLogs() {
      try {
        const table = document.getElementById('activityLogsTable');
        const wrapper = table ? table.closest('.card') : null;
        if (wrapper) {
          wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } catch(e) {}
    }

    function clearActivityLogs(){
      try{
        const key = '__duobuddy_store__';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        const filtered = arr.filter(x => x.type !== 'activity_log');
        localStorage.setItem(key, JSON.stringify(filtered));
        if (typeof dataHandler !== 'undefined' && dataHandler.onDataChanged) {
          dataHandler.onDataChanged(filtered);
        }
        showToast('üóëÔ∏è Activity logs cleared');
      } catch(e){ showToast('Failed to clear logs', 'error'); }
    }

    async function handleApprovePayment(event){
      event.preventDefault();
      const slot = parseInt(document.getElementById('approveCardSlot').value);
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if(!user){ showToast('User not found', 'error'); return; }
      try{ const r = await apiRequest('/api/admin/approve', { method:'POST', body: JSON.stringify({ id: user.__backendId, slot }) }); if(r.ok){ showToast('‚úÖ Payment approved'); closeAdminUserModal(); await refreshAdminUsers(); } else { showToast('Failed to approve', 'error'); } } catch(e){ showToast('Failed to approve', 'error'); }
    }

    function exportUsersToCSV() {
      const users = allUsers.filter(u => !u.is_admin);
      
      if (!users.length) {
        showToast('No users to export', 'error');
        return;
      }
      
      const headers = ['Name', 'Email', 'Username', 'Phone', 'Status', 'Job Title', 'Company', 'Joined Date', 'Trial End', 'Payment Approved', 'Deleted'];
      
      const rows = users.map(u => {
        const profileData = u.data ? JSON.parse(u.data) : {};
        const status = getUserStatus(u);
        
        return [
          u.name,
          u.email,
          u.username,
          u.phone,
          status,
          profileData.jobTitle || '',
          profileData.company || '',
          profileData.created ? new Date(profileData.created).toLocaleDateString() : '',
          profileData.trialEnd ? new Date(profileData.trialEnd).toLocaleDateString() : '',
          profileData.paymentApproved ? 'Yes' : 'No',
          u.deleted ? 'Yes' : 'No'
        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
      });
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showToast('üì• Users exported to CSV!');
      logActivity('export_csv', currentUser?.__backendId, currentUser?.name || 'Admin', `Exported ${users.length} users to CSV`);
    }

    function exportActivityLogs() {
      if (!activityLogs.length) {
        showToast('No activity logs to export', 'error');
        return;
      }
      
      const headers = ['Timestamp', 'User', 'Activity Type', 'Details'];
      
      const rows = activityLogs.map(log => {
        return [
          new Date(log.timestamp).toLocaleString(),
          log.name,
          log.activity_type,
          log.details
        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
      });
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `activity_logs_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showToast('üì• Activity logs exported!');
    }

    let selectedUserId = null;

    function handleAdminCardDesignUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        showToast('Image size must be less than 10MB', 'error');
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgEl = document.getElementById('adminCardDesignPreview');
        imgEl.src = e.target.result;
        imgEl.style.display = 'block';
        document.getElementById('removeAdminCardDesignBtn').style.display = 'inline-block';
        
        showToast('‚úÖ Card design uploaded!');
      };
      reader.readAsDataURL(file);
    }
    
    function removeAdminCardDesign() {
      const imgEl = document.getElementById('adminCardDesignPreview');
      imgEl.style.display = 'none';
      imgEl.src = '';
      document.getElementById('removeAdminCardDesignBtn').style.display = 'none';
      document.getElementById('adminCardDesignUpload').value = '';
      
      showToast('Card design removed');
    }

    function openAdminUserModal(userId) {
      const user = allUsers.find(u => u.__backendId === userId);
      if (!user) return;
      
      selectedUserId = userId;
      document.getElementById('adminModalUserName').textContent = user.name;
      document.getElementById('adminModalUserEmail').textContent = user.email;
      document.getElementById('adminCurrentEmail').value = user.email;
      document.getElementById('adminUserModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      const profileData = user.data ? JSON.parse(user.data) : {};
      const activeCards = (profileData.cards || []).filter(c => c.status === 'active');
      const slotInput = document.getElementById('approveCardSlot');
      document.getElementById('adminCardCountText').textContent = `Cards owned: ${activeCards.length}`;
      if (activeCards.length >= 1) { slotInput.disabled = true; } else { slotInput.disabled = false; }
      
      // Show payment proof if available
      const pendingOrders = (profileData.cards || []).filter(c => c.status === 'pending_approval');
      
      if (pendingOrders.length > 0 && pendingOrders[0].paymentProof) {
        document.getElementById('adminPaymentProofSection').style.display = 'block';
        document.getElementById('adminPaymentProofImage').src = pendingOrders[0].paymentProof;
        document.getElementById('adminPaymentProofImage').style.display = 'block';
        document.getElementById('adminNoPaymentProof').style.display = 'none';
        document.getElementById('approveCardSlot').value = pendingOrders[0].slot;
      } else {
        document.getElementById('adminPaymentProofSection').style.display = 'none';
      }

      const qrType = pendingOrders[0]?.qrType || 'none';
      const qrText = pendingOrders[0]?.qrText || '';
      const qrSec = document.getElementById('adminBackQrSection');
      const qrInfo = document.getElementById('adminBackQrInfo');
      const qrImg = document.getElementById('adminBackQrImage');
      const qrLink = document.getElementById('adminBackQrLink');
      if(qrType && qrType!=='none' && qrText){
        qrInfo.textContent = `Type: ${qrType} ‚Ä¢ Link: ${qrText}`;
        qrLink.href = qrText; qrLink.style.display='inline-block';
        qrImg.style.display='none';
        const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ qrImg.src=img.src; qrImg.style.display='inline-block'; }; img.src=`https://quickchart.io/qr?text=${encodeURIComponent(qrText)}&size=160`;
        qrSec.style.display='block';
      } else { qrSec.style.display='none'; }

      const designImg = pendingOrders[0]?.designImage || '';
      const assetsSec = document.getElementById('adminAssetsSection');
      const dPrev = document.getElementById('adminDesignImagePreview');
      const dDl = document.getElementById('adminDesignImageDownload');
      const pDl = document.getElementById('adminPaymentProofDownload');
      if(designImg){ dPrev.src=designImg; dPrev.style.display='block'; dDl.href=designImg; dDl.style.display='inline-block'; } else { dPrev.style.display='none'; dDl.style.display='none'; }
      const payImg = pendingOrders[0]?.paymentProof || '';
      if(payImg){ pDl.href=payImg; pDl.style.display='inline-block'; } else { pDl.style.display='none'; }
      assetsSec.style.display = (designImg || payImg) ? 'block' : 'none';
      
      // Reset form fields
      document.getElementById('approvePaymentForm').reset();
      document.getElementById('adminNewPassword').value = '';
      document.getElementById('adminCardDesignPreview').style.display = 'none';
      document.getElementById('removeAdminCardDesignBtn').style.display = 'none';
      hideDeleteConfirmation();
      const saSection = document.getElementById('subAdminApprovalSection');
      if (saSection) saSection.style.display = (user.is_subadmin && !profileData.profileApproved) ? 'block' : 'none';
      const delCard = document.getElementById('adminDeleteUserSection');
      if (delCard) { delCard.style.display = isSubAdmin ? 'none' : 'block'; }
      const createCardSection = document.getElementById('adminCreateCardSection');
      if (createCardSection) createCardSection.style.display = isAdmin ? 'block' : 'none';
      const tSel = document.getElementById('adminCreateQrType');
      const phoneEl = document.getElementById('adminCreatePhone');
      const qrTextEl = document.getElementById('adminCreateQrText');
      if (tSel) tSel.onchange = function(){
        const t = tSel.value;
        const phone = (phoneEl && phoneEl.value ? phoneEl.value : '').replace(/\D/g,'');
        if (t==='whatsapp') { qrTextEl.value = phone ? ('https://wa.me/60' + phone) : ''; }
        else if (t==='profile' && selectedUserId) { qrTextEl.value = user.username ? ('https://duobuddy.my/' + user.username) : ''; }
        else if (t==='none') { qrTextEl.value = ''; }
      };
      if (phoneEl) phoneEl.oninput = function(){
        const t = document.getElementById('adminCreateQrType').value;
        if (t==='whatsapp') {
          const phone = phoneEl.value.replace(/\D/g,'');
          qrTextEl.value = phone ? ('https://wa.me/60' + phone) : '';
        }
      };
    }

    function closeAdminUserModal() {
      document.getElementById('adminUserModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      selectedUserId = null;
    }

    async function handleApprovePayment(event) {
      event.preventDefault();
      
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if (!user) return;
      
      const slotNumber = parseInt(document.getElementById('approveCardSlot').value);
      const nfcSerial = document.getElementById('adminNfcSerial').value;
      const nfcPassword = document.getElementById('adminNfcPassword').value;
      
      if (slotNumber < 1 || slotNumber > 10) {
        showToast('Card slot must be between 1 and 10', 'error');
        return;
      }
      
      const designImg = document.getElementById('adminCardDesignPreview');
      const designImage = designImg.style.display !== 'none' ? designImg.src : null;
      try {
        const r = await apiRequest('/api/admin/approve', { method: 'POST', body: JSON.stringify({ userId: selectedUserId, slot: slotNumber, nfcSerial, nfcPassword, designImage }) });
        if (r.ok) {
          const data = await r.json();
          showToast(`‚úÖ Payment approved! Card slot ${slotNumber} activated for ${user.name}`);
          document.getElementById('approvePaymentForm').reset();
          document.getElementById('adminCardDesignPreview').style.display = 'none';
          document.getElementById('removeAdminCardDesignBtn').style.display = 'none';
          setTimeout(() => closeAdminUserModal(), 1500);
        } else {
          showToast('Failed to approve payment', 'error');
        }
      } catch(e) {
        showToast('Failed to approve payment', 'error');
      }
    }

    async function handleAdminDeleteCard(){
      const slotNumber = parseInt(document.getElementById('approveCardSlot').value);
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if(!user){ showToast('User not found', 'error'); return; }
      if(!confirm('Are you sure you want to delete this card slot to allow reorder?')) return;
      try{
        const r = await apiRequest('/api/admin/delete_card', { method: 'POST', body: JSON.stringify({ user_id: user.__backendId, slot: slotNumber }) });
        if(r.ok){ showToast('üóëÔ∏è Card slot deleted'); closeAdminUserModal(); await refreshAdminUsers(); }
        else { showToast('Failed to delete card slot', 'error'); }
      }catch(e){ showToast('Failed to delete card slot', 'error'); }
    }

    async function handleAdminCreateCard(event){
      event.preventDefault();
      const u = allUsers.find(function(x){ return x.__backendId===selectedUserId; });
      if(!u){ showToast('User not found','error'); return; }
      const slot = parseInt(document.getElementById('adminCreateSlot').value,10);
      const design = document.getElementById('adminCreateDesign').value;
      const nameText = document.getElementById('adminCreateName').value.trim();
      const phoneText = document.getElementById('adminCreatePhone').value.trim();
      const qrType = document.getElementById('adminCreateQrType').value;
      const qrText = document.getElementById('adminCreateQrText').value.trim();
      const showPhoneOnCard = !!document.getElementById('adminCreateShowPhone').checked;
      const fileEl = document.getElementById('adminCreateDesignImage');
      var designImage = '';
      if (fileEl && fileEl.files && fileEl.files[0]) {
        designImage = await new Promise(function(resolve,reject){ var r=new FileReader(); r.onload=function(){ resolve(r.result); }; r.onerror=reject; r.readAsDataURL(fileEl.files[0]); });
      }
      const payload = { user_id: u.__backendId, slot: slot, design: design, nameText: nameText, phoneText: phoneText, qrType: qrType, qrText: qrText, showPhoneOnCard: showPhoneOnCard, designImage: designImage };
      try {
        const r = await apiRequest('/api/admin/create_card', { method: 'POST', body: JSON.stringify(payload) });
        if (r.ok) { showToast('‚úÖ Card created for user'); closeAdminUserModal(); await refreshAdminUsers(); }
        else { showToast('Failed to create card','error'); }
      } catch(e){ showToast('Failed to create card','error'); }
    }

    async function handleAdminChangeEmail(){
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if (!user) return;
      const newEmail = document.getElementById('adminNewEmail').value;
      try{ const r = await apiRequest('/api/admin/email', { method:'POST', body: JSON.stringify({ id: user.__backendId, email: newEmail }) }); if(r.ok){ showToast('Email updated'); await refreshAdminUsers(); closeAdminUserModal(); } else { showToast('Failed to update email', 'error'); } } catch(e){ showToast('Failed to update email', 'error'); }
    }

    async function handleAdminResetPassword(event) {
      event.preventDefault();
      
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if (!user) return;
      
      const newPassword = document.getElementById('adminNewPassword').value;
      
      if (newPassword.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }
      
      try {
        const r = await apiRequest('/api/admin/reset_password', { method: 'POST', body: JSON.stringify({ id: user.__backendId, password: newPassword }) });
        if (r.ok) {
          showToast(`üîê Password reset for ${user.name}`);
          await logActivity('admin_reset_password', user.__backendId, user.name, `Admin reset password for ${user.email}`);
          document.getElementById('adminResetPasswordForm').reset();
          setTimeout(() => closeAdminUserModal(), 1500);
        } else {
          showToast('Failed to reset password', 'error');
        }
      } catch(e) {
        showToast('Failed to reset password', 'error');
      }
    }

    function showDeleteConfirmation() {
      document.getElementById('deleteUserConfirm').style.display = 'none';
      document.getElementById('deleteUserFinal').style.display = 'block';
    }

    function hideDeleteConfirmation() {
      document.getElementById('deleteUserConfirm').style.display = 'block';
      document.getElementById('deleteUserFinal').style.display = 'none';
    }

    async function handleDeleteUser() {
      const user = allUsers.find(u => u.__backendId === selectedUserId);
      if (!user) return;
      try{
        const r = await apiRequest('/api/admin/delete', { method: 'POST', body: JSON.stringify({ id: user.__backendId }) });
        if(r.ok){ showToast(`üóëÔ∏è User ${user.name} marked as deleted`); closeAdminUserModal(); await refreshAdminUsers(); }
        else { showToast('Failed to delete user', 'error'); }
      } catch(e){ showToast('Failed to delete user', 'error'); }
    }

    async function handleRestoreUser(id){
      try{ const r = await apiRequest('/api/admin/restore', { method: 'POST', body: JSON.stringify({ id }) }); if(r.ok){ showToast('‚úÖ User restored'); await refreshAdminUsers(); } else { showToast('Failed to restore user', 'error'); } } catch(e){ showToast('Failed to restore user', 'error'); }
    }

    function handleSignOut() {
      apiRequest('/api/auth/logout', { method: 'POST' }).finally(() => {
        currentUser = null;
        isAdmin = false;
        showToast('üëã Signed out successfully');
        setTimeout(() => showPage('homepage'), 1000);
      });
    }

    function showBulkOrderModal() {
      document.getElementById('bulkOrderModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeBulkOrderModal() {
      document.getElementById('bulkOrderModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      document.getElementById('bulkOrderForm').reset();
    }

    function handleBulkOrderRequest(event) {
      event.preventDefault();
      
      const companyName = document.getElementById('bulkCompanyName').value;
      const contactPerson = document.getElementById('bulkContactPerson').value;
      const email = document.getElementById('bulkEmail').value;
      const phone = document.getElementById('bulkPhone').value;
      const quantity = document.getElementById('bulkQuantity').value;
      const message = document.getElementById('bulkMessage').value;
      
      showToast('‚úÖ Request submitted! We\'ll contact you within 24 hours.');
      closeBulkOrderModal();
    }

    function openProfilePreview() {
      if (!currentUser) return;
      
      const profileData = currentUser.data ? JSON.parse(currentUser.data) : {};
      const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
      
      const avatarEl = document.getElementById('previewProfileAvatar');
      const imgEl = document.getElementById('previewProfileImage');
      
      avatarEl.textContent = initials;
      
      if (profileData.profilePicture) {
        avatarEl.style.display = 'none';
        imgEl.src = profileData.profilePicture;
        imgEl.style.display = 'block';
      } else {
        avatarEl.style.display = 'flex';
        imgEl.style.display = 'none';
      }
      
      document.getElementById('previewProfileName').textContent = currentUser.name;
      document.getElementById('previewProfileTitle').textContent = profileData.jobTitle || 'Add your job title';
      document.getElementById('previewProfileEmail').textContent = currentUser.email;
      document.getElementById('previewProfilePhone').textContent = currentUser.phone;
      document.getElementById('previewProfileCompany').textContent = profileData.company || 'Add your company';
      document.getElementById('previewProfileAbout').textContent = profileData.about || 'Tell people about yourself...';
      document.getElementById('previewProfileURL').textContent = `duobuddy.my/${currentUser.username}`;
      
      renderContactActions('previewProfileContactActions', currentUser.phone, profileData.whatsapp);
      renderSocialLinks('previewProfileSocialLinks', profileData);
      
      document.getElementById('profilePreviewModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeProfilePreview() {
      document.getElementById('profilePreviewModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openPublicProfileInNewTab() {
      if (!currentUser) return;
      const path = pageToPath('public-profile', currentUser.username);
      const url = getPublicOrigin() + path;
      window.open(url, '_blank');
    }

  initApp();
  document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
  document.addEventListener('keydown', function(e){
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) { e.preventDefault(); }
    if (e.key === 'F12') { e.preventDefault(); }
  });
</script>
</body>
</html>
